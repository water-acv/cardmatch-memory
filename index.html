<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å†¬ç©ºã®æ–‡èŠ¸å¾©èˆˆ ã‚«ãƒ¼ãƒ‰ãƒãƒƒãƒ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Interãƒ•ã‚©ãƒ³ãƒˆã‚’é©ç”¨ */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=Noto+Sans+JP:wght(400;700)&display=swap');
        body {
            font-family: 'Noto Sans JP', 'Inter', sans-serif;
            background-color: #f4f7f9;
        }
        .card-slot {
            transition: all 0.3s ease;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.06);
            height: 120px; /* ã‚«ãƒ¼ãƒ‰ã®é«˜ã•å›ºå®š */
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            border: 4px solid transparent;
            position: relative;
        }
        .card-known {
            background-color: #ffffff;
            border-color: #a7f3d0; /* Known: light green */
            color: #1f2937;
        }
        .card-unknown {
            background-color: #b91c1c; /* èµ¤ã„ã‚«ãƒ¼ãƒ‰è£é¢ã‚’ã‚¤ãƒ¡ãƒ¼ã‚¸ */
            color: white;
        }
        .card-matched {
            background-color: #d1d5db; /* Grayed out */
            color: #6b7280;
            cursor: default;
            opacity: 0.6;
            border-color: #9ca3af;
        }
        .card-suggested {
            border-color: #f59e0b; /* Suggested: amber */
            animation: pulse-border 1.5s infinite;
        }
        .card-flipping {
            border-color: #4f46e5; /* Flipping: Indigo */
            border-width: 4px;
        }
        .edit-button-disabled {
            opacity: 0.4;
            cursor: not-allowed;
        }
        @keyframes pulse-border {
            0% { box-shadow: 0 0 0 0 rgba(245, 158, 11, 0.4); }
            70% { box-shadow: 0 0 0 10px rgba(245, 158, 11, 0); }
            100% { box-shadow: 0 0 0 0 rgba(245, 158, 11, 0); }
        }
    </style>
</head>
<body class="p-4 md:p-8">

    <div class="max-w-4xl mx-auto bg-white p-6 rounded-xl shadow-2xl">
        <h1 class="text-3xl font-bold text-center mb-6 text-gray-800 border-b-2 pb-2">
            å†¬ç©ºã®æ–‡èŠ¸å¾©èˆˆ ã‚«ãƒ¼ãƒ‰ãƒãƒƒãƒ
        </h1>

        <!-- 1. ã‚«ãƒ¼ãƒ‰ã‚°ãƒªãƒƒãƒ‰ -->
        <div id="card-grid" class="grid grid-cols-6 gap-3 mb-6">
            <!-- ã‚«ãƒ¼ãƒ‰ã‚¹ãƒ­ãƒƒãƒˆã¯JSã§ç”Ÿæˆã•ã‚Œã¾ã™ -->
        </div>

        <!-- 1.5. ç¨®é¡é¸æŠãƒ‘ãƒãƒ« -->
        <div id="selection-panel" class="mb-6 p-4 rounded-xl bg-gray-100 hidden text-center shadow-inner">
            <!-- é¸æŠãƒœã‚¿ãƒ³ã¯JSã§ã“ã“ã«æç”»ã•ã‚Œã¾ã™ -->
        </div>

        <!-- 2. æ”»ç•¥æƒ…å ±ãƒ‘ãƒãƒ« -->
        <div class="mb-6 p-4 rounded-lg bg-indigo-50 shadow-inner">
            <h2 class="text-xl font-semibold mb-3 text-indigo-700 flex items-center">
                <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.275a1.12 1.12 0 011.053 0L12 4.184 2.329 8.725a1.12 1.12 0 00.103 2.016l.118-.016h.005zm0 0a1.12 1.12 0 00-.103-2.016l-.118.016h-.005zm0 0l-9.878 4.506c-.442.202-.736.637-.736 1.124v2.75c0 .487.294.922.736 1.124l.005.002.118-.016a1.12 1.12 0 011.053 0L12 19.816l9.671-4.417a1.12 1.12 0 00.103-2.016l-.118.016h-.005v-2.75c0-.487-.294-.922-.736-1.124l-.005-.002zM12 21.816V4.184"></path></svg>
                æ¬¡ã®ä¸€æ‰‹ æ”»ç•¥ææ¡ˆ
            </h2>
            <p id="suggestion-text" class="text-gray-700 font-medium text-lg"></p>
        </div>

        <!-- 3. è¨˜æ†¶æ¸ˆã¿ã®ã‚«ãƒ¼ãƒ‰ãƒªã‚¹ãƒˆ -->
        <div class="mb-6 p-4 rounded-lg bg-white border border-gray-200 shadow-lg">
            <h2 class="text-xl font-semibold mb-3 text-gray-800">è¨˜æ†¶æ¸ˆã¿ã‚«ãƒ¼ãƒ‰ä¸€è¦§</h2>
            <div id="memory-list" class="space-y-2">
                <p class="text-sm text-gray-500">ã‚«ãƒ¼ãƒ‰ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ç¨®é¡ã‚’å…¥åŠ›ã™ã‚‹ã¨ã€ã“ã“ã«æƒ…å ±ãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚</p>
            </div>
        </div>

        <!-- 4. ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ãƒœã‚¿ãƒ³ -->
        <div class="flex flex-col items-center justify-center gap-4">
            <button onclick="resetGame(true)" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-6 rounded-lg transition duration-150 shadow-md">
                ã‚²ãƒ¼ãƒ ãƒªã‚»ãƒƒãƒˆ (æœ€åˆã‹ã‚‰ã‚„ã‚Šç›´ã™)
            </button>
            <!-- ä¿å­˜çŠ¶æ³ã®è¡¨ç¤º -->
            <p id="storage-status" class="text-sm text-gray-500 mt-2"></p>
        </div>
    </div>

    <script>
        // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
        const STORAGE_KEY = 'memoryGameSolverState';
        const NUM_CARDS = 12;
        // ã‚«ãƒ¼ãƒ‰ãƒ‡ãƒ¼ã‚¿: ãƒ¬ã‚¢åº¦ã¨è‰²ã‚’å®šç¾©
        const CARD_RARITY_MAP = {
            'ãƒ¤ã‚¯ãƒ¢': { rarity: 'SSR', color: 'bg-purple-400' }, 
            'ã‚¿ã‚«ãƒ': { rarity: 'SSR', color: 'bg-purple-400' }, 
            'ãƒŸãƒãƒª': { rarity: 'SR', color: 'bg-yellow-300' }, 
            'ãƒãƒ‰ã‚«': { rarity: 'SR', color: 'bg-yellow-300' }, 
            'ãƒˆãƒ¢ã‚¨': { rarity: 'R', color: 'bg-blue-400' }, 
            'è¦ªè¡›éšŠ': { rarity: 'N', color: 'bg-gray-400' }, 
        };
        const RARITY_ORDER = { 'SSR': 3, 'SR': 2, 'R': 1, 'N': 0 }; 
        const CARD_TYPES = Object.keys(CARD_RARITY_MAP);

        let memoryMap = Array(NUM_CARDS).fill(null); // å„ä½ç½®ã®ã‚«ãƒ¼ãƒ‰ç¨®é¡ (null:ä¸æ˜, 'ãƒ¤ã‚¯ãƒ¢':æ—¢çŸ¥)
        let matchedIndices = []; // ãƒšã‚¢ãŒæƒã£ãŸã‚«ãƒ¼ãƒ‰ã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹
        let currentFlipIndices = []; // ç¾åœ¨ã‚ãã£ã¦ã„ã‚‹ã‚«ãƒ¼ãƒ‰ã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ (æœ€å¤§2ã¤)
        let isInputtingTypes = false; // 2æšã‚ãã‚Šå¾Œã«ç¨®é¡å…¥åŠ›ä¸­ãƒ•ãƒ©ã‚°

        const cardGridEl = document.getElementById('card-grid');
        const suggestionTextEl = document.getElementById('suggestion-text');
        const memoryListEl = document.getElementById('memory-list');
        const selectionPanelEl = document.getElementById('selection-panel');
        const storageStatusEl = document.getElementById('storage-status');

        // --- ãƒ‡ãƒ¼ã‚¿æ°¸ç¶šåŒ– (localStorage) ---

        /**
         * ã‚²ãƒ¼ãƒ ã®çŠ¶æ…‹ã‚’ localStorage ã«ä¿å­˜ã™ã‚‹
         */
        function saveGame() {
            try {
                const state = {
                    memoryMap: memoryMap,
                    matchedIndices: matchedIndices,
                };
                localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
                updateStorageStatus(true);
            } catch (e) {
                console.error('Failed to save game state to localStorage:', e);
                updateStorageStatus(false, 'ä¿å­˜å¤±æ•—');
            }
        }

        /**
         * localStorage ã‹ã‚‰ã‚²ãƒ¼ãƒ ã®çŠ¶æ…‹ã‚’èª­ã¿è¾¼ã‚€
         * @returns {boolean} ãƒ­ãƒ¼ãƒ‰ã«æˆåŠŸã—ãŸã‹ã©ã†ã‹
         */
        function loadGame() {
            try {
                const storedState = localStorage.getItem(STORAGE_KEY);
                if (storedState) {
                    const state = JSON.parse(storedState);
                    // èª­ã¿è¾¼ã‚“ã ãƒ‡ãƒ¼ã‚¿ã§çŠ¶æ…‹ã‚’æ›´æ–°
                    if (Array.isArray(state.memoryMap) && state.memoryMap.length === NUM_CARDS) {
                        memoryMap = state.memoryMap;
                        matchedIndices = Array.isArray(state.matchedIndices) ? state.matchedIndices : [];
                        // currentFlipIndices, isInputtingTypes ã¯ãƒªãƒ­ãƒ¼ãƒ‰æ™‚ã«ã¯ãƒªã‚»ãƒƒãƒˆã™ã‚‹
                        currentFlipIndices = [];
                        isInputtingTypes = false;
                        console.log('ã‚²ãƒ¼ãƒ ã®çŠ¶æ…‹ã‚’localStorageã‹ã‚‰å¾©å…ƒã—ã¾ã—ãŸã€‚');
                        updateStorageStatus(true, 'å¾©å…ƒ');
                        return true;
                    }
                }
            } catch (e) {
                console.error('Failed to load game state from localStorage:', e);
            }
            // èª­ã¿è¾¼ã¿å¤±æ•—ã¾ãŸã¯ãƒ‡ãƒ¼ã‚¿ãŒãªã„å ´åˆ
            updateStorageStatus(false, 'æ–°è¦é–‹å§‹');
            return false;
        }

        /**
         * ä¿å­˜çŠ¶æ³ã®è¡¨ç¤ºã‚’æ›´æ–°ã™ã‚‹
         * @param {boolean} success - æˆåŠŸã—ãŸã‹ã©ã†ã‹
         * @param {string} mode - 'å¾©å…ƒ' | 'æ–°è¦é–‹å§‹' | 'ä¿å­˜å¤±æ•—' | 'ãƒªã‚»ãƒƒãƒˆ'
         */
        function updateStorageStatus(success, mode) {
            let message = '';
            if (mode === 'å¾©å…ƒ') {
                message = 'âœ… ä»¥å‰ã®çŠ¶æ…‹ã‹ã‚‰å¾©å…ƒã—ã¾ã—ãŸã€‚';
            } else if (mode === 'æ–°è¦é–‹å§‹') {
                message = 'åˆå›ã‚¢ã‚¯ã‚»ã‚¹ã§ã™ã€‚ãƒ‡ãƒ¼ã‚¿ã¯è‡ªå‹•ä¿å­˜ã•ã‚Œã¾ã™ã€‚';
            } else if (mode === 'ãƒªã‚»ãƒƒãƒˆ') {
                message = 'ğŸ”„ ä¿å­˜ãƒ‡ãƒ¼ã‚¿ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã—ãŸã€‚æ–°è¦ã‚²ãƒ¼ãƒ ã‚’é–‹å§‹ã—ã¾ã™ã€‚';
            } else if (mode === 'ä¿å­˜å¤±æ•—') {
                message = 'âŒ ãƒ‡ãƒ¼ã‚¿ã®è‡ªå‹•ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸã€‚';
            } else if (success) {
                 message = 'ğŸ’¾ çŠ¶æ…‹ã‚’è‡ªå‹•ä¿å­˜ã—ã¾ã—ãŸã€‚';
            }
            storageStatusEl.textContent = message;
        }

        // --- åˆæœŸåŒ–ã¨ãƒªã‚»ãƒƒãƒˆ ---

        /**
         * ã‚²ãƒ¼ãƒ ã®çŠ¶æ…‹ã‚’åˆæœŸåŒ–ã—ã€ã‚°ãƒªãƒƒãƒ‰ã‚’æç”»ã™ã‚‹
         * @param {boolean} [forceReset=false] - trueã®å ´åˆã€localStorageã®ãƒ‡ãƒ¼ã‚¿ã‚‚å‰Šé™¤ã—ã¦å¼·åˆ¶ãƒªã‚»ãƒƒãƒˆ
         */
        function resetGame(forceReset = false) {
            if (forceReset) {
                localStorage.removeItem(STORAGE_KEY);
                updateStorageStatus(true, 'ãƒªã‚»ãƒƒãƒˆ');
            }

            if (!loadGame()) {
                // å¾©å…ƒã•ã‚Œãªã‹ã£ãŸå ´åˆã€æ–°è¦ã«åˆæœŸåŒ–
                memoryMap = Array(NUM_CARDS).fill(null);
                matchedIndices = [];
                currentFlipIndices = [];
                isInputtingTypes = false;
            } else if (forceReset) {
                // å¼·åˆ¶ãƒªã‚»ãƒƒãƒˆæ™‚ã¯ã“ã“ã§å†åº¦åˆæœŸåŒ–
                memoryMap = Array(NUM_CARDS).fill(null);
                matchedIndices = [];
            }
            
            // UIã‚’æ›´æ–°
            currentFlipIndices = []; // ã‚ãã‚Šä¸­ã¯ãƒªã‚»ãƒƒãƒˆ
            isInputtingTypes = false; // ç¨®é¡å…¥åŠ›ã‚‚ãƒªã‚»ãƒƒãƒˆ
            renderGrid();
            renderSelectionPanel(); 
            updateSuggestion();
            updateMemoryList();
            
            // åˆå›ãƒ­ãƒ¼ãƒ‰æ™‚ã€ã¾ãŸã¯ãƒªã‚»ãƒƒãƒˆæ™‚ä»¥å¤–ã¯ã“ã“ã§saveGameã¯ä¸è¦
            if (!forceReset) {
                saveGame(); // åˆå›ãƒ­ãƒ¼ãƒ‰æ™‚ã«ç©ºãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜ï¼ˆãƒ‡ãƒ¼ã‚¿ãŒãªã„å ´åˆï¼‰
            }
            console.log('ã‚²ãƒ¼ãƒ ã®çŠ¶æ…‹ã‚’åˆæœŸåŒ–/å¾©å…ƒã—ã¾ã—ãŸã€‚');
        }

        // --- UIãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚° ---

        /**
         * ã‚«ãƒ¼ãƒ‰ã‚°ãƒªãƒƒãƒ‰ã‚’æç”»ã¾ãŸã¯æ›´æ–°ã™ã‚‹
         */
        function renderGrid() {
            cardGridEl.innerHTML = '';
            // ç·¨é›†ãƒœã‚¿ãƒ³ã‚’ç„¡åŠ¹åŒ–ã™ã‚‹ã‹ã©ã†ã‹åˆ¤å®š
            const isAnyFlipOrInput = currentFlipIndices.length > 0 || isInputtingTypes;

            for (let i = 0; i < NUM_CARDS; i++) {
                const cardEl = document.createElement('div');
                cardEl.className = 'card-slot rounded-lg font-bold text-center flex-col';
                cardEl.setAttribute('data-index', i);

                const cardType = memoryMap[i];
                const isMatched = matchedIndices.includes(i);
                const isFlipping = currentFlipIndices.includes(i);
                
                let contentHTML = '';
                let bgColorClass = 'card-unknown hover:bg-red-500';
                let borderColorClass = '';

                if (isMatched) {
                    // ãƒšã‚¢æˆç«‹æ¸ˆã¿
                    const cardData = CARD_RARITY_MAP[cardType];
                    bgColorClass = `card-matched ${cardData.color.replace('300', '100').replace('400', '100')}`; 
                    contentHTML = `<span class="text-sm font-light text-gray-500">MATCHED</span><span class="text-lg">${cardType}</span>`;
                    cardEl.onclick = null;
                } else if (cardType !== null) {
                    // ç¨®é¡æ—¢çŸ¥ (éå»ã«ã‚ãã‚‰ã‚ŒãŸæƒ…å ±) - ç·¨é›†ãƒœã‚¿ãƒ³ã‚’è¿½åŠ 
                    const cardData = CARD_RARITY_MAP[cardType];
                    bgColorClass = `card-known ${cardData.color}`;
                    
                    // ç·¨é›†ãƒœã‚¿ãƒ³ã®åˆ¶å¾¡
                    const editButtonClass = isAnyFlipOrInput ? 'edit-button-disabled' : 'hover:bg-indigo-600';
                    const editButtonAction = isAnyFlipOrInput ? 
                        `event.stopPropagation(); console.log('ç¾åœ¨ã€ã‚ãã‚Šä¸­/ç¨®é¡å…¥åŠ›ä¸­ã®ãŸã‚ç·¨é›†ã§ãã¾ã›ã‚“ã€‚');` : 
                        `event.stopPropagation(); handleEditCardType(${i})`;

                    contentHTML = `<span class="text-lg">${cardType}</span>
                                   <button onclick="${editButtonAction}" 
                                           class="absolute bottom-1 right-1 text-xs px-2 py-0.5 bg-indigo-500 text-white rounded transition duration-150 shadow-md ${editButtonClass}">ç·¨é›†</button>`;
                    cardEl.onclick = () => handleCardClick(i); 
                } else {
                    // ç¨®é¡ä¸æ˜ (è£é¢)
                    contentHTML = `<span class="text-2xl">?</span><span class="text-sm">ä½ç½® ${i + 1}</span>`;
                    cardEl.onclick = () => handleCardClick(i); 
                }

                if (isFlipping) {
                    // ã‚ãã‚Šä¸­ã®ã‚«ãƒ¼ãƒ‰ã¯ç‰¹æ®Šãªãƒã‚¤ãƒ©ã‚¤ãƒˆã‚’é©ç”¨
                    borderColorClass = 'card-flipping';
                    cardEl.classList.remove('card-unknown'); 
                    if (isInputtingTypes) {
                        // ç¨®é¡å…¥åŠ›ãƒ•ã‚§ãƒ¼ã‚º
                        if (memoryMap[i] === null) {
                            // æœªç¢ºå®šã®ã‚«ãƒ¼ãƒ‰ã«ç‚¹æ»…ãƒã‚¤ãƒ©ã‚¤ãƒˆ
                            borderColorClass = 'border-4 border-red-500 ring-4 ring-red-300 animate-pulse';
                        } else {
                            // ç¨®é¡ãŒç¢ºå®šã—ã¦ã„ã‚‹ãŒã¾ã ãƒšã‚¢ãƒã‚§ãƒƒã‚¯å‰
                             borderColorClass = 'border-4 border-green-500 ring-4 ring-green-300';
                        }
                    } else if (cardType !== null) {
                        // 1æšç›®ç¢ºå®šæ¸ˆã¿ã®æ—¢çŸ¥ã‚«ãƒ¼ãƒ‰
                        const cardData = CARD_RARITY_MAP[cardType];
                        bgColorClass = `card-known ${cardData.color}`;
                    }
                }
                
                cardEl.className = `card-slot rounded-lg font-bold text-center flex-col ${bgColorClass} ${borderColorClass}`;
                cardEl.innerHTML = contentHTML;

                // ä½ç½®è¡¨ç¤º
                const positionText = (i < 6 ? `ä¸Šæ®µ-${i % 6 + 1}` : `ä¸‹æ®µ-${i % 6 + 1}`);
                const positionEl = document.createElement('div');
                positionEl.className = 'absolute top-1 left-2 text-xs font-light opacity-75';
                positionEl.textContent = positionText;
                cardEl.prepend(positionEl);

                cardGridEl.appendChild(cardEl);
            }
            updateSuggestion();
        }

        /**
         * ç¨®é¡é¸æŠãƒ‘ãƒãƒ«ã®HTMLã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’ç”Ÿæˆã—ã€æç”»ã™ã‚‹
         */
        function renderSelectionPanel() {
            if (!isInputtingTypes) {
                selectionPanelEl.classList.add('hidden');
                selectionPanelEl.innerHTML = '';
                return;
            }

            const [idx1, idx2] = currentFlipIndices;
            let targetIndex = -1; // æ¬¡ã«ç¨®é¡ã‚’å…¥åŠ›ã™ã‚‹ã‚«ãƒ¼ãƒ‰ã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹
            
            // ã©ã¡ã‚‰ã®ã‚«ãƒ¼ãƒ‰ã®ç¨®é¡ã‚’å…¥åŠ›ã™ã¹ãã‹åˆ¤å®š (idx2ã¯ undefined ã®å ´åˆã‚‚ã‚ã‚Šå¾—ã‚‹)
            if (memoryMap[idx1] === null) {
                targetIndex = idx1;
            } else if (idx2 !== undefined && memoryMap[idx2] === null) {
                targetIndex = idx2;
            } else {
                // ä¸¡æ–¹å…¥åŠ›æ¸ˆã¿ (å‡¦ç†ã®æ•´åˆæ€§ã‚’ä¿ã¤ãŸã‚ã€å³åº§ã«ãƒšã‚¢ãƒã‚§ãƒƒã‚¯ã¸)
                isInputtingTypes = false;
                processPairCheck(); 
                return;
            }

            const positionText = (targetIndex < 6 ? `ä¸Šæ®µ-${targetIndex % 6 + 1}` : `ä¸‹æ®µ-${targetIndex % 6 + 1}`);
            const indexNumber = currentFlipIndices.length === 1 ? 1 : (targetIndex === idx1 ? 1 : 2); // 1æšç›®ã‹2æšç›®ã‹
            const isEditing = currentFlipIndices.length === 1 && memoryMap[idx1] === null;

            let headerText = isEditing 
                ? `<span class="text-xl text-indigo-600 font-extrabold">ç¨®é¡ã‚’ä¿®æ­£</span> (**ä½ç½® ${positionText}**) ã®ã‚«ãƒ¼ãƒ‰ç¨®é¡ã‚’é¸æŠã—ã¦ãã ã•ã„`
                : `<span class="text-xl text-red-600 font-extrabold">${indexNumber}æšç›®</span> (**ä½ç½® ${positionText}**) ã®ã‚«ãƒ¼ãƒ‰ç¨®é¡ã‚’é¸æŠã—ã¦ãã ã•ã„`;

            // æ—¢ã«ãƒãƒƒãƒãƒ³ã‚°å®Œäº†ã—ãŸç¨®é¡ã‚’ç‰¹å®šã—ã€é¸æŠè‚¢ã‹ã‚‰é™¤å¤–ã™ã‚‹
            const fullyMatchedTypes = new Set();
            memoryMap.forEach((type, index) => {
                if (type !== null && matchedIndices.includes(index)) {
                    // ãã®typeãŒ2å›ä»¥ä¸Šå‡ºç¾ã™ã‚‹ã‹ç¢ºèª (2å›ã§ãƒšã‚¢å®Œäº†)
                    if (matchedIndices.filter(i => memoryMap[i] === type).length === 2) {
                        fullyMatchedTypes.add(type);
                    }
                }
            });
            const availableTypes = CARD_TYPES.filter(type => !fullyMatchedTypes.has(type));


            let html = `<p class="text-lg font-bold mb-3 text-gray-800">${headerText}</p>`;
            html += '<div class="flex flex-wrap gap-3 justify-center">'; 
            
            // ãƒ¬ã‚¢åº¦é †ã«ã‚½ãƒ¼ãƒˆã—ã¦ãƒœã‚¿ãƒ³ã‚’è¡¨ç¤º
            const sortedTypes = availableTypes.sort((a, b) => {
                return RARITY_ORDER[CARD_RARITY_MAP[b].rarity] - RARITY_ORDER[CARD_RARITY_MAP[a].rarity];
            });

            sortedTypes.forEach(type => {
                const cardData = CARD_RARITY_MAP[type];
                const textColor = cardData.rarity === 'SSR' || cardData.rarity === 'SR' ? 'text-gray-900' : 'text-white';
                
                html += `<button onclick="confirmCardType('${type}')" 
                                class="rounded-lg ${cardData.color} ${textColor} font-semibold shadow-lg py-3 px-6 transition duration-150 hover:opacity-90 transform hover:scale-[1.02] active:scale-[0.98]">
                            ${type} (${cardData.rarity})
                        </button>`;
            });
            html += `</div>`;
            
            let cancelText = isEditing ? 'ä¿®æ­£ã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã™ã‚‹' : 'ã‚ãã‚Šã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã—ã¦è£é¢ã«æˆ»ã™ (æƒ…å ±ãƒªã‚»ãƒƒãƒˆ)';
            html += `<button onclick="cancelInput()" class="mt-4 text-sm text-gray-600 hover:text-red-600 font-medium">${cancelText}</button>`;
            
            selectionPanelEl.innerHTML = html;
            selectionPanelEl.classList.remove('hidden');
        }

        /**
         * è¨˜æ†¶æ¸ˆã¿ã®ã‚«ãƒ¼ãƒ‰ä¸€è¦§ã‚’æ›´æ–°ã™ã‚‹
         */
        function updateMemoryList() {
            const knownCards = {}; 
            let totalKnown = 0;

            memoryMap.forEach((type, index) => {
                if (type !== null && !matchedIndices.includes(index)) {
                    if (!knownCards[type]) {
                        knownCards[type] = [];
                    }
                    knownCards[type].push(index);
                    totalKnown++;
                }
            });

            if (totalKnown === 0) {
                memoryListEl.innerHTML = '<p class="text-sm text-gray-500">ã¾ã ã‚ãã‚‰ã‚ŒãŸã‚«ãƒ¼ãƒ‰ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</p>';
                return;
            }

            memoryListEl.innerHTML = '';
            // ãƒ¬ã‚¢åº¦é †ã«ã‚½ãƒ¼ãƒˆã—ã¦è¡¨ç¤º
            const sortedTypes = Object.keys(knownCards).sort((a, b) => {
                return RARITY_ORDER[CARD_RARITY_MAP[b].rarity] - RARITY_ORDER[CARD_RARITY_MAP[a].rarity];
            });

            sortedTypes.forEach(type => {
                const indices = knownCards[type];
                const cardData = CARD_RARITY_MAP[type];

                const positionList = indices.map(i => {
                    return i < 6 ? `ä¸Šæ®µ-${i % 6 + 1}` : `ä¸‹æ®µ-${i % 6 + 1}`;
                }).join('ã€');

                const listItem = document.createElement('div');
                // ãƒªã‚¹ãƒˆã®è‰²ã‚‚ã‚«ãƒ¼ãƒ‰ã®ãƒ¬ã‚¢ãƒªãƒ†ã‚£ã‚«ãƒ©ãƒ¼ã¨é€£å‹•ã•ã›ã‚‹
                listItem.className = `p-2 rounded-lg flex justify-between items-center ${cardData.color.replace('300', '100').replace('400', '100')} border-l-4 border-l-indigo-600`;
                listItem.innerHTML = `
                    <span class="font-semibold text-gray-800">${type} (${cardData.rarity})</span>
                    <span class="text-sm text-gray-600">${indices.length}æš: ${positionList}</span>
                `;
                memoryListEl.appendChild(listItem);

                // 2æšæƒã£ã¦ã„ã‚‹å ´åˆã¯ã€Œæƒã†å¯èƒ½æ€§ã‚ã‚Šã€ã¨è¡¨ç¤º
                if (indices.length === 1) {
                    const hintItem = document.createElement('div');
                    hintItem.className = 'text-xs text-red-600 ml-4';
                    hintItem.textContent = 'â†’ ã‚ã¨1æšã§ãƒšã‚¢ã§ã™ï¼';
                    memoryListEl.appendChild(hintItem);
                }
            });
        }

        // --- ãƒ­ã‚¸ãƒƒã‚¯ã¨ã‚¹ãƒˆãƒ©ãƒ†ã‚¸ãƒ¼ ---

        /**
         * æ—¢çŸ¥ã®ã‚«ãƒ¼ãƒ‰ã®ç¨®é¡ã‚’å†å…¥åŠ›ã™ã‚‹ãŸã‚ã®ãƒ¢ãƒ¼ãƒ‰ã‚’é–‹å§‹ã™ã‚‹
         * @param {number} index - ç·¨é›†ã™ã‚‹ã‚«ãƒ¼ãƒ‰ã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹
         */
        function handleEditCardType(index) {
            // ç¾åœ¨ã®æ“ä½œä¸­ã§ã¯ãªã„ã“ã¨ã‚’ç¢ºèª (ã“ã®ãƒã‚§ãƒƒã‚¯ã¯HTMLå´ã§ã‚‚è¡Œã£ã¦ã„ã‚‹ãŒå¿µã®ãŸã‚)
            if (matchedIndices.includes(index) || currentFlipIndices.length > 0 || isInputtingTypes) {
                console.log("ç·¨é›†ã§ãã¾ã›ã‚“ã€‚");
                return;
            }

            console.log(`ä½ç½® ${index + 1} ã®ã‚«ãƒ¼ãƒ‰ç¨®é¡ã‚’å†å…¥åŠ›ã—ã¾ã™ã€‚`);
            
            // çŠ¶æ…‹ã‚’ãƒªã‚»ãƒƒãƒˆã—ã€ã“ã®ã‚«ãƒ¼ãƒ‰ã‚’ã‚ãã‚Šä¸­ã®1æšç›®ã¨ã—ã¦è¨­å®š
            currentFlipIndices = [index]; 
            
            // ç¨®é¡æƒ…å ±ã‚’ä¸€æ—¦ãƒªã‚»ãƒƒãƒˆ (ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«ç¨®é¡ã‚’é¸æŠã•ã›ã‚‹ãŸã‚)
            memoryMap[index] = null; 
            
            isInputtingTypes = true;
            renderGrid(); // ãƒã‚¤ãƒ©ã‚¤ãƒˆæ›´æ–°
            renderSelectionPanel(); // ç¨®é¡å…¥åŠ›ãƒ‘ãƒãƒ«ã‚’è¡¨ç¤º
            saveGame();
        }

        /**
         * ã‚«ãƒ¼ãƒ‰ã‚¯ãƒªãƒƒã‚¯æ™‚ã®çµ±åˆãƒãƒ³ãƒ‰ãƒ©ï¼ˆã‚ãã‚Šæ“ä½œï¼‰
         * @param {number} index - ã‚¯ãƒªãƒƒã‚¯ã•ã‚ŒãŸã‚«ãƒ¼ãƒ‰ã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹
         */
        function handleCardClick(index) {
            // ç¨®é¡å…¥åŠ›ä¸­ã¯ã€ã‚«ãƒ¼ãƒ‰æ“ä½œã‚’ç„¡åŠ¹ã«ã™ã‚‹
            if (isInputtingTypes) {
                console.log("ç¾åœ¨ã€ã‚ãã£ãŸã‚«ãƒ¼ãƒ‰ã®ç¨®é¡å…¥åŠ›ä¸­ã§ã™ã€‚");
                return;
            }
            // ãƒšã‚¢æˆç«‹æ¸ˆã¿ã‚«ãƒ¼ãƒ‰ã¯æ“ä½œä¸å¯
            if (matchedIndices.includes(index)) {
                return;
            }
            
            // ã™ã§ã«ã‚ãã‚Šä¸­ã®ã‚«ãƒ¼ãƒ‰ã¯æ“ä½œä¸å¯
            if (currentFlipIndices.includes(index)) {
                return;
            }

            // --- æ—¢çŸ¥ã®ã‚«ãƒ¼ãƒ‰ (ç¨®é¡ãŒnullã§ãªã„ã‚‚ã®) ã®å‡¦ç† ---
            // æ—¢çŸ¥ã®ã‚«ãƒ¼ãƒ‰ã¯ã€ãƒšã‚¢ã‚’æƒãˆã‚‹ãŸã‚ã®ã€Œã‚ãã‚Šã€ã¨ã—ã¦æ©Ÿèƒ½ã•ã›ã‚‹
            if (memoryMap[index] !== null) {
                
                // 1æšç›®ã¨ã—ã¦é¸æŠ
                if (currentFlipIndices.length === 0) {
                    currentFlipIndices.push(index);
                    renderGrid();
                    updateSuggestion();
                    console.log(`æ—¢çŸ¥ã®ã‚«ãƒ¼ãƒ‰ (ä½ç½® ${index + 1}, ${memoryMap[index]}) ã‚’1æšç›®ã¨ã—ã¦ã‚ãã‚Šã¾ã—ãŸã€‚`);
                    return;
                } 
                
                // 2æšç›®ã¨ã—ã¦é¸æŠ
                if (currentFlipIndices.length === 1) {
                    currentFlipIndices.push(index);
                    // ç¨®é¡ãŒæ—¢ã«ã‚ã‹ã£ã¦ã„ã‚‹ã®ã§ã€ç¨®é¡å…¥åŠ›ã¯ã‚¹ã‚­ãƒƒãƒ—ã—ã€å³æ™‚ãƒšã‚¢ãƒã‚§ãƒƒã‚¯
                    isInputtingTypes = false; 
                    renderGrid(); // ãƒã‚¤ãƒ©ã‚¤ãƒˆæ›´æ–°
                    processPairCheck(); 
                    console.log(`æ—¢çŸ¥ã®ã‚«ãƒ¼ãƒ‰ (ä½ç½® ${index + 1}, ${memoryMap[index]}) ã‚’2æšç›®ã¨ã—ã¦ã‚ãã‚Šã¾ã—ãŸã€‚å³æ™‚ãƒšã‚¢ãƒã‚§ãƒƒã‚¯ã‚’å®Ÿè¡Œã—ã¾ã™ã€‚`);
                    return;
                }
                
                // 2æšãƒ•ãƒªãƒƒãƒ—æ¸ˆã¿ã®çŠ¶æ…‹ã§æ—¢çŸ¥ã®ã‚«ãƒ¼ãƒ‰ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ãŸå ´åˆã¯ä½•ã‚‚ã—ãªã„
                return;
            }
            
            // --- ç¨®é¡ä¸æ˜ã®ã‚«ãƒ¼ãƒ‰ (é€šå¸¸ã®ã‚ãã‚Š) ã®å‡¦ç† ---

            // 1æšç›®ã¾ãŸã¯2æšç›®ã¨ã—ã¦ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’è¿½åŠ  (é€šå¸¸ã®ãƒ•ãƒªãƒƒãƒ—å‡¦ç†)
            currentFlipIndices.push(index);

            if (currentFlipIndices.length === 1) {
                // 1æšç›®ã‚ãã‚Š: 2æšç›®ã‚’å¾…ã¤
                renderGrid();
                updateSuggestion();
            } else if (currentFlipIndices.length === 2) {
                // 2æšç›®ã‚ãã‚Š: ç¨®é¡å…¥åŠ›ãƒ¢ãƒ¼ãƒ‰ã«ç§»è¡Œ
                isInputtingTypes = true; 
                renderGrid(); // ãƒã‚¤ãƒ©ã‚¤ãƒˆæ›´æ–°
                renderSelectionPanel(); // ç¨®é¡å…¥åŠ›ãƒ‘ãƒãƒ«ã‚’è¡¨ç¤º
            }
            // ã‚ãã‚Šä¸­ã®ã‚«ãƒ¼ãƒ‰ã®çŠ¶æ…‹è‡ªä½“ã¯ memoryMap ã«å½±éŸ¿ã—ãªã„ãŸã‚ã€saveGameã¯ä¸è¦ï¼ˆç¨®é¡ç¢ºå®šæ™‚ã«ä¿å­˜ï¼‰
        }

        /**
         * ç¾åœ¨å…¥åŠ›ä¸­ã®ã‚«ãƒ¼ãƒ‰ã®ç¨®é¡ã‚’ç¢ºå®šã—ã€æ¬¡ã®å…¥åŠ›ã¸é€²ã‚€ã‹ãƒšã‚¢ãƒã‚§ãƒƒã‚¯ã‚’è¡Œã†
         * @param {string} type - ç¢ºå®šã—ãŸã‚«ãƒ¼ãƒ‰ã®ç¨®é¡
         */
        function confirmCardType(type) {
            // currentFlipIndicesãŒ1æšã—ã‹ãªã„å ´åˆï¼ˆå†å…¥åŠ›æ™‚ï¼‰ã‚‚å¯¾å¿œ
            if (!isInputtingTypes || currentFlipIndices.length < 1) return;

            const [idx1, idx2] = currentFlipIndices;
            
            let targetIndex = -1; 
            if (memoryMap[idx1] === null) {
                targetIndex = idx1; // 1æšç›®ã®ç¨®é¡ã‚’å…¥åŠ›
            } else if (idx2 !== undefined && memoryMap[idx2] === null) {
                targetIndex = idx2; // 2æšç›®ã®ç¨®é¡ã‚’å…¥åŠ›
            } else {
                // ä¸¡æ–¹å…¥åŠ›æ¸ˆã¿ï¼ˆé€šå¸¸ã¯ç™ºç”Ÿã—ãªã„ã¯ãšï¼‰
                return;
            }

            // ç¨®é¡ã‚’è¨˜æ†¶
            memoryMap[targetIndex] = type;
            saveGame(); // è¨˜æ†¶æƒ…å ±ãŒæ›´æ–°ã•ã‚ŒãŸæ™‚ç‚¹ã§ä¿å­˜

            if (idx2 === undefined || (memoryMap[idx1] !== null && memoryMap[idx2] !== null)) {
                // 1æšã®å†å…¥åŠ›å®Œäº†ã€ã¾ãŸã¯2æšã¨ã‚‚ç¨®é¡ãŒç¢ºå®šã—ãŸ -> ãƒšã‚¢ãƒã‚§ãƒƒã‚¯ã¸
                isInputtingTypes = false;
                
                // ã‚‚ã—1æšã®å†å…¥åŠ›å®Œäº†ã§ã€currentFlipIndicesãŒ1æšã—ã‹ãªã‘ã‚Œã°ã€
                // çŠ¶æ…‹ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¦ææ¡ˆã‚’æ›´æ–°ã™ã‚‹ (è£é¢ã«æˆ»ã™)
                if (currentFlipIndices.length === 1) {
                    currentFlipIndices = [];
                    renderGrid();
                    renderSelectionPanel(); // ãƒ‘ãƒãƒ«ã‚’éè¡¨ç¤ºã«ã™ã‚‹
                    updateMemoryList();
                    updateSuggestion();
                } else {
                    // 2æšãƒ•ãƒªãƒƒãƒ—çŠ¶æ…‹ã‹ã‚‰ã®å®Œäº†
                    renderSelectionPanel(); // ãƒ‘ãƒãƒ«ã‚’éè¡¨ç¤ºã«ã™ã‚‹ãŸã‚ã«å…ˆã«å‘¼ã¶
                    processPairCheck();
                }
            } else {
                // 1æšç›®ã®ç¨®é¡ãŒç¢ºå®šã—ãŸ -> 2æšç›®ã®ç¨®é¡å…¥åŠ›ãƒ‘ãƒãƒ«ã‚’å†æç”»
                renderGrid();
                renderSelectionPanel();
            }
        }
        
        /**
         * ãƒšã‚¢ãƒã‚§ãƒƒã‚¯ã‚’è¡Œã„ã€çŠ¶æ…‹ã‚’æ›´æ–°ã™ã‚‹
         */
        function processPairCheck() {
            const [idx1, idx2] = currentFlipIndices;
            const type1 = memoryMap[idx1];
            const type2 = memoryMap[idx2];
            
            if (type1 === type2) {
                // ãƒšã‚¢æˆç«‹ï¼
                setTimeout(() => {
                    matchedIndices.push(idx1, idx2);
                    currentFlipIndices = []; // ãƒšã‚¢æˆç«‹ã§ã‚ãã‚Šä¸­ã‚’ãƒªã‚»ãƒƒãƒˆ
                    renderGrid();
                    updateMemoryList();
                    updateSuggestion();
                    saveGame(); // ãƒšã‚¢æˆç«‹å¾Œã®æœ€çµ‚çŠ¶æ…‹ã‚’ä¿å­˜
                }, 500); // æˆç«‹ã—ãŸãƒšã‚¢ã‚’å°‘ã—è¡¨ç¤ºã—ã¦ã‹ã‚‰æ¶ˆã™
            } else {
                // ãƒšã‚¢ä¸æˆç«‹ã€‚ã‚ãã‚Šä¸­ãƒ•ãƒ©ã‚°ã‚’ãƒªã‚»ãƒƒãƒˆã€‚
                setTimeout(() => {
                    currentFlipIndices = [];
                    renderGrid();
                    updateSuggestion();
                    // memoryMapè‡ªä½“ã¯å¤‰ã‚ã£ã¦ã„ãªã„ã®ã§ã€saveGameã¯ä¸è¦
                }, 1000); // 1ç§’å¾Œã«ãƒªã‚»ãƒƒãƒˆ
            }
        }

        /**
         * ã‚ãã‚Šã¨ç¨®é¡å…¥åŠ›ã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã—ã€è£é¢ã«æˆ»ã™
         */
        function cancelInput() {
            // ç¨®é¡å…¥åŠ›ä¸­ã«ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã—ãŸå ´åˆã€ã‚ãã‚Šä¸­ã®ã‚«ãƒ¼ãƒ‰ (memoryMap[i] === null ã®ã‚‚ã®) ã¯
            // null ã®ã¾ã¾æ®‹ã‚‹ãŸã‚ã€è£é¢ã«æˆ»ã‚‹
            isInputtingTypes = false;
            currentFlipIndices = [];
            renderGrid();
            renderSelectionPanel();
            updateMemoryList();
            updateSuggestion();
            saveGame(); // ç·¨é›†ãƒ¢ãƒ¼ãƒ‰ã‹ã‚‰ã®ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã§ memoryMap ãŒå¤‰æ›´ã•ã‚ŒãŸå¯èƒ½æ€§ãŒã‚ã‚‹ãŸã‚ä¿å­˜
        }

        /**
         * æ¬¡ã«ã‚ãã‚‹ã¹ãã‚«ãƒ¼ãƒ‰ã‚’ææ¡ˆã—ã€UIã‚’æ›´æ–°ã™ã‚‹
         */
        function updateSuggestion() {
            // ç¨®é¡å…¥åŠ›ä¸­ã®å ´åˆã¯ãƒ‘ãƒãƒ«ã¸ã®èª˜å°ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º
            if (isInputtingTypes) {
                suggestionTextEl.innerHTML = "ğŸš¨ **ç¨®é¡å…¥åŠ›ä¸­**ï¼šç”»é¢ä¸‹éƒ¨ã®ãƒ‘ãƒãƒ«ã‹ã‚‰ã€ã‚ãã£ãŸã‚«ãƒ¼ãƒ‰ã®ç¨®é¡ã‚’é †ç•ªã«ã€ã¾ãŸã¯ä¿®æ­£ã—ã¦ç¢ºå®šã—ã¦ãã ã•ã„ï¼";
                return;
            }

            // ææ¡ˆãƒ­ã‚¸ãƒƒã‚¯
            let suggestedIndex = -1;
            let suggestionMessage = "ğŸ¤” **ã€æ¢ç´¢é–‹å§‹ã€‘** ã¾ãšã¯ä¸æ˜ãªã‚«ãƒ¼ãƒ‰ã‚’1æšã‚ãã‚Šã€è¨˜æ†¶æƒ…å ±ã‚’å¢—ã‚„ã—ã¾ã—ã‚‡ã†ã€‚";

            // 1. æ—¢çŸ¥ã®ãƒšã‚¢ã‚’æƒãˆã‚‹ (æœ€å„ªå…ˆ)
            const knownPairs = {}; // { type: [index1, index2, ...] }
            memoryMap.forEach((type, index) => {
                if (type !== null && !matchedIndices.includes(index)) {
                    knownPairs[type] = (knownPairs[type] || []).concat(index);
                }
            });

            let matchablePair = null;
            let matchableType = null;

            // ãƒ¬ã‚¢åº¦é †ã«ãƒ«ãƒ¼ãƒ—ã—ã€ãƒšã‚¢ãŒæƒã†ã‚‚ã®ã‚’æ¢ã™
            const sortedTypes = Object.keys(knownPairs).sort((a, b) => {
                return RARITY_ORDER[CARD_RARITY_MAP[b].rarity] - RARITY_ORDER[CARD_RARITY_MAP[a].rarity];
            });

            for (const type of sortedTypes) {
                const indices = knownPairs[type];
                if (indices.length === 2) {
                    // ãƒšã‚¢ç™ºè¦‹ï¼ (ä¸€ç•ªãƒ¬ã‚¢åº¦ã®é«˜ã„ã‚‚ã®ã‚’å„ªå…ˆ)
                    matchablePair = indices;
                    matchableType = type;
                    break; 
                }
            }

            const isFirstFlip = currentFlipIndices.length === 1;
            // æœªçŸ¥ã‹ã¤æœªãƒãƒƒãƒã‹ã¤ã‚ãã‚Šä¸­ã§ãªã„ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã®ãƒªã‚¹ãƒˆ
            const unknownIndices = memoryMap.map((type, i) => 
                (type === null && !matchedIndices.includes(i) && !currentFlipIndices.includes(i) ? i : -1)
            ).filter(i => i !== -1);

            if (matchablePair) {
                // æ—¢çŸ¥ã®ãƒšã‚¢ã‚’æƒãˆã‚‹
                const currentFlipIndex = isFirstFlip ? currentFlipIndices[0] : -1;
                let targetIndex = -1;
                
                if (isFirstFlip && matchablePair.includes(currentFlipIndex)) {
                    // 1æšç›®ãŒãƒšã‚¢ã®ä¸€æ–¹ã®å ´åˆã¯ã€ã‚‚ã†ä¸€æ–¹ã‚’ææ¡ˆ
                    targetIndex = matchablePair.find(i => i !== currentFlipIndex);
                } else if (!isFirstFlip) {
                    // 0æšã‚ãã‚Šã®å ´åˆã¯ã€ãƒšã‚¢ã®ä¸€æ–¹ã‚’ææ¡ˆ (ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ãŒå°ã•ã„æ–¹)
                    targetIndex = matchablePair[0];
                }
                
                // ææ¡ˆå¯¾è±¡ãŒç¾åœ¨ã®ã‚ãã‚Šä¸­ã§ã¯ãªã„ã“ã¨ã‚’ç¢ºèª
                if (targetIndex !== -1 && !currentFlipIndices.includes(targetIndex)) {
                     suggestedIndex = targetIndex;
                     const position = suggestedIndex < 6 ? `ä¸Šæ®µ-${suggestedIndex % 6 + 1}` : `ä¸‹æ®µ-${suggestedIndex % 6 + 1}`;
                     suggestionMessage = `ğŸŒŸ **ã€æœ€å„ªå…ˆã€‘æ—¢çŸ¥ã®ãƒšã‚¢**ï¼š${matchableType} (${CARD_RARITY_MAP[matchableType].rarity}) ã®ã‚«ãƒ¼ãƒ‰ã‚’æƒãˆã¾ã—ã‚‡ã†ï¼**ä½ç½® ${position}** ã‚’ã‚ãã£ã¦ãã ã•ã„ã€‚`;
                }

            } else if (isFirstFlip) {
                // 2. 1æšç›®ã‚ãã‚Šä¸­ã§ã€2æšç›®å€™è£œã‚’æ¢ã™ (è¨˜æ†¶æƒ…å ±ã«ãªã„å ´åˆ)
                // 2æšç›®ã¨ã—ã¦ã‚ãã‚‹ã¹ãã¯ã€ã‚ãã‚Šä¸­ã§ãªã„ä¸æ˜ãªã‚«ãƒ¼ãƒ‰ã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ãŒæœ€ã‚‚è‹¥ã„ã‚‚ã®
                if (unknownIndices.length > 0) {
                    suggestedIndex = unknownIndices[0];
                    const position = suggestedIndex < 6 ? `ä¸Šæ®µ-${suggestedIndex % 6 + 1}` : `ä¸‹æ®µ-${suggestedIndex % 6 + 1}`;
                    suggestionMessage = `ğŸ’¡ **ã€è¨˜æ†¶ã‚’å¢—ã‚„ã™ã€‘** ãƒšã‚¢ã«ãªã‚‹ã‚«ãƒ¼ãƒ‰ã¯ã¾ã ä¸æ˜ã§ã™ã€‚æ¬¡ã®ä¸æ˜ãªã‚«ãƒ¼ãƒ‰ã€**ä½ç½® ${position}** ã‚’ã‚ãã‚Šã€è¨˜æ†¶ã‚’å¢—ã‚„ã—ã¾ã—ã‚‡ã†ã€‚`;
                } else {
                     // 1æšç›®ã‚ãã‚Šä¸­ã§ã€æ®‹ã‚Šã®ã‚«ãƒ¼ãƒ‰ãŒã™ã¹ã¦æ—¢çŸ¥ï¼ˆæœªæˆç«‹ï¼‰ã¾ãŸã¯ãƒãƒƒãƒæ¸ˆã¿
                     suggestionMessage = `ğŸ§ **ã€æ®‹ã‚Šã‚’æ¢ã‚‹ã€‘** 1æšç›®ã®ã‚«ãƒ¼ãƒ‰ã®ãƒšã‚¢ã¯ã¾ã ä¸æ˜ã§ã™ã€‚æ®‹ã‚Šã¯æ—¢çŸ¥ã®ã‚«ãƒ¼ãƒ‰ã—ã‹ã‚ã‚Šã¾ã›ã‚“ã€‚è¨˜æ†¶æ¸ˆã¿ã®ã‚«ãƒ¼ãƒ‰ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ã€æ®‹ã‚Š1æšã®ãƒšã‚¢ã‚’æ¢ã‚‹ã‹ã€ã‚ãã‚Šã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã—ã¾ã—ã‚‡ã†ã€‚`;
                }

            } else if (currentFlipIndices.length === 0) {
                // 3. 1æšç›®ã‚’ã‚ãã‚‹
                if (unknownIndices.length > 0) {
                    // æ¬¡ã«ã‚ãã‚‹ã®ã¯ã€ã‚ãã‚Šä¸­ã§ãªã„ä¸æ˜ãªã‚«ãƒ¼ãƒ‰ã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ãŒæœ€ã‚‚è‹¥ã„ã‚‚ã®
                    suggestedIndex = unknownIndices[0];
                    const position = suggestedIndex < 6 ? `ä¸Šæ®µ-${suggestedIndex % 6 + 1}` : `ä¸‹æ®µ-${suggestedIndex % 6 + 1}`;
                    suggestionMessage = `ğŸ¤” **ã€æ¢ç´¢é–‹å§‹ã€‘** ã¾ãšã¯ä¸æ˜ãªã‚«ãƒ¼ãƒ‰ã€**ä½ç½® ${position}** ã‚’ã‚ãã£ã¦æƒ…å ±ã‚’å–å¾—ã—ã¾ã—ã‚‡ã†ã€‚`;
                } else if (matchedIndices.length === NUM_CARDS) {
                    suggestionMessage = "ğŸ‰ ã™ã¹ã¦ã®ãƒšã‚¢ãŒæƒã„ã¾ã—ãŸï¼ã‚²ãƒ¼ãƒ ã‚¯ãƒªã‚¢ã§ã™ï¼";
                } else {
                    // ã™ã¹ã¦æ—¢çŸ¥ã ãŒã€ã¾ã æƒã£ã¦ã„ãªã„ã‚«ãƒ¼ãƒ‰ãŒã‚ã‚‹å ´åˆ (ä¾‹: æ—¢çŸ¥ãŒ1æšã®ã¿)
                    suggestionMessage = "ğŸ§ **ã€è¨˜æ†¶æ¸ˆã¿ã€‘** ã™ã¹ã¦ã®è£é¢ã‚«ãƒ¼ãƒ‰ã‚’ã‚ãã‚Šçµ‚ãˆã¾ã—ãŸã€‚æ¬¡ã®ã‚¿ãƒ¼ãƒ³ã¯è¨˜æ†¶æ¸ˆã¿ã®ã‚«ãƒ¼ãƒ‰ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ãƒšã‚¢ã‚’æƒãˆã¾ã—ã‚‡ã†ã€‚";
                }
            }
            
            // UIã‚’æ›´æ–°
            suggestionTextEl.innerHTML = suggestionMessage;

            // ææ¡ˆã•ã‚ŒãŸã‚«ãƒ¼ãƒ‰ã«ãƒã‚¤ãƒ©ã‚¤ãƒˆã‚’é©ç”¨
            document.querySelectorAll('.card-slot').forEach(el => {
                const index = parseInt(el.getAttribute('data-index'));
                
                // ææ¡ˆãƒã‚¤ãƒ©ã‚¤ãƒˆã‚’ãƒªã‚»ãƒƒãƒˆ
                el.classList.remove('card-suggested');
                el.style.animation = 'none';
                void el.offsetWidth; // å¼·åˆ¶çš„ã«ãƒªãƒ•ãƒ­ãƒ¼

                // ç¾åœ¨ã‚ãã‚Šä¸­ã®ã‚«ãƒ¼ãƒ‰ã«ã¯ææ¡ˆãƒã‚¤ãƒ©ã‚¤ãƒˆã‚’é©ç”¨ã—ãªã„
                if (index === suggestedIndex && !currentFlipIndices.includes(suggestedIndex)) {
                    el.classList.add('card-suggested');
                    el.style.animation = 'pulse-border 1.5s infinite';
                }
            });
        }

        // --- ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ ---
        // ãƒšãƒ¼ã‚¸ã®ãƒ­ãƒ¼ãƒ‰æ™‚ã¾ãŸã¯ãƒªã‚»ãƒƒãƒˆãƒœã‚¿ãƒ³ã‚¯ãƒªãƒƒã‚¯æ™‚ã«å®Ÿè¡Œ
        window.onload = () => resetGame(false);

    </script>
</body>
</html>