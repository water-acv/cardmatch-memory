<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å†¬ç©ºã®æ–‡èŠ¸å¾©èˆˆ ã‚«ãƒ¼ãƒ‰ãƒãƒƒãƒ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Interãƒ•ã‚©ãƒ³ãƒˆã‚’é©ç”¨ */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=Noto+Sans+JP:wght(400;700)&display=swap');
        body {
            font-family: 'Noto Sans JP', 'Inter', sans-serif;
            background-color: #f4f7f9;
        }
        .card-slot {
            transition: all 0.3s ease;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.06);
            height: 110px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            border: 4px solid transparent;
            position: relative;
            padding: 4px;
        }
        /* ã‚«ãƒ¼ãƒ‰å†…å®¹ã®ãƒ©ãƒƒãƒ‘ãƒ¼ã€‚flex-colã§ç¸¦ã«é…ç½® */
        .card-content {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            width: 100%;
            /* ä¿®æ­£ç‚¹: padding-bottomã‚’å¢—ã‚„ã—ã€å†…å®¹ã‚’ä¸Šéƒ¨ã«ç§»å‹•ã•ã›ã¦ç·¨é›†ãƒœã‚¿ãƒ³ã¨ã®é‡ãªã‚Šã‚’å›é¿ */
            padding-bottom: 28px; 
        }
        /* ã‚«ãƒ¼ãƒ‰å†…éƒ¨ã®ãƒ†ã‚­ã‚¹ãƒˆã‚µã‚¤ã‚ºèª¿æ•´ */
        .card-slot .text-lg {
            font-size: 1.05rem;
            line-height: 1.1;
            margin-top: 0;
        }
        .card-slot .text-sm {
            font-size: 0.75rem;
        }

        .card-known {
            /* èƒŒæ™¯è‰²ã¯JSã§ã‚¤ãƒ³ãƒ©ã‚¤ãƒ³è¨­å®šã•ã‚Œã‚‹ */
            color: #1f2937; /* æ¿ƒã„æ–‡å­—è‰²ã‚’åŸºæœ¬ã¨ã™ã‚‹ */
        }
        .card-unknown {
            background-color: #b91c1c; /* èµ¤ã„ã‚«ãƒ¼ãƒ‰è£é¢ã‚’ã‚¤ãƒ¡ãƒ¼ã‚¸ */
            color: white;
        }
        .card-matched {
            background-color: #e5e7eb; /* è–„ã„ã‚°ãƒ¬ãƒ¼ã«å›ºå®š */
            color: #6b7280;
            cursor: default;
            opacity: 0.7;
            border-color: #9ca3af;
        }
        .card-suggested {
            border-color: #06b6d4; /* Suggested: cyan (Palette A) */
            animation: pulse-border 1.5s infinite;
        }
        .card-flipping {
            border-color: #4f46e5; /* Flipping: Indigo */
            border-width: 4px;
        }
        /* ç·¨é›†ãƒœã‚¿ãƒ³ã®çµ¶å¯¾ä½ç½®ã¨ã‚µã‚¤ã‚ºã‚’èª¿æ•´ */
        .edit-button {
            position: absolute;
            bottom: 2px;
            right: 2px;
            font-size: 0.7rem;
            padding: 0.1rem 0.4rem; 
            line-height: 1;
        }
        .edit-button-disabled {
            opacity: 0.4;
            cursor: not-allowed;
        }
        .position-text {
             position: absolute;
             top: 2px;
             left: 2px;
             font-size: 0.7rem;
             font-weight: 300;
             opacity: 0.75;
             line-height: 1;
        }
        @keyframes pulse-border {
            0% { box-shadow: 0 0 0 0 rgba(6, 182, 212, 0.4); }
            70% { box-shadow: 0 0 0 10px rgba(6, 182, 212, 0); }
            100% { box-shadow: 0 0 0 0 rgba(6, 182, 212, 0); }
        }
    </style>
</head>
<body class="p-4 md:p-8">

    <div class="max-w-4xl mx-auto bg-white p-6 rounded-xl shadow-2xl">
        <h1 class="text-3xl font-bold text-center mb-6 text-gray-800 border-b-2 pb-2">
            å†¬ç©ºã®æ–‡èŠ¸å¾©èˆˆ ã‚«ãƒ¼ãƒ‰ãƒãƒƒãƒ
        </h1>

        <!-- 1. ã‚«ãƒ¼ãƒ‰ã‚°ãƒªãƒƒãƒ‰ -->
        <div id="card-grid" class="grid grid-cols-6 gap-3 mb-6">
            <!-- ã‚«ãƒ¼ãƒ‰ã‚¹ãƒ­ãƒƒãƒˆã¯JSã§ç”Ÿæˆã•ã‚Œã¾ã™ -->
        </div>

        <!-- 1.5. ç¨®é¡é¸æŠãƒ‘ãƒãƒ« -->
        <div id="selection-panel" class="mb-6 p-4 rounded-xl bg-gray-100 hidden text-center shadow-inner">
            <!-- é¸æŠãƒœã‚¿ãƒ³ã¯JSã§ã“ã“ã«æç”»ã•ã‚Œã¾ã™ -->
        </div>
        
        <!-- 1.6. è­¦å‘Šãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ -->
        <div id="alert-message" class="mb-6 p-3 rounded-lg bg-yellow-100 text-yellow-800 font-semibold hidden">
            <!-- è­¦å‘Šãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™ -->
        </div>

        <!-- 2. æ”»ç•¥æƒ…å ±ãƒ‘ãƒãƒ« -->
        <div class="mb-6 p-4 rounded-lg bg-indigo-50 shadow-inner">
            <h2 class="text-xl font-semibold mb-3 text-indigo-700 flex items-center">
                <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.275a1.12 1.12 0 011.053 0L12 4.184 2.329 8.725a1.12 1.12 0 00.103 2.016l.118-.016h.005zm0 0a1.12 1.12 0 00-.103-2.016l-.118.016h-.005zm0 0l-9.878 4.506c-.442.202-.736.637-.736 1.124v2.75c0 .487.294.922.736 1.124l.005.002.118-.016a1.12 1.12 0 011.053 0L12 19.816l9.671-4.417a1.12 1.12 0 00.103-2.016l-.118.016h-.005v-2.75c0-.487-.294-.922-.736-.1.124l-.005-.002zM12 21.816V4.184"></path></svg>
                æ¬¡ã®ä¸€æ‰‹ æ”»ç•¥ææ¡ˆ
            </h2>
            <p id="suggestion-text" class="text-gray-700 font-medium text-lg"></p>
        </div>

        <!-- 3. è¨˜æ†¶æ¸ˆã¿ã®ã‚«ãƒ¼ãƒ‰ãƒªã‚¹ãƒˆ -->
        <div class="mb-6 p-4 rounded-lg bg-white border border-gray-200 shadow-lg">
            <h2 class="text-xl font-semibold mb-3 text-gray-800">è¨˜æ†¶æ¸ˆã¿ã‚«ãƒ¼ãƒ‰ä¸€è¦§</h2>
            <div id="memory-list" class="space-y-2">
                <p class="text-sm text-gray-500">ã‚«ãƒ¼ãƒ‰ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ç¨®é¡ã‚’å…¥åŠ›ã™ã‚‹ã¨ã€ã“ã“ã«æƒ…å ±ãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚</p>
            </div>
        </div>

        <!-- 4. ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ãƒœã‚¿ãƒ³ -->
        <div class="flex flex-col items-center justify-center gap-4">
            <button onclick="showConfirmResetModal()" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-6 rounded-lg transition duration-150 shadow-md">
                ã‚²ãƒ¼ãƒ ãƒªã‚»ãƒƒãƒˆ (æœ€åˆã‹ã‚‰ã‚„ã‚Šç›´ã™)
            </button>
            <!-- ä¿å­˜çŠ¶æ³ã®è¡¨ç¤º -->
            <p id="storage-status" class="text-sm text-gray-500 mt-2"></p>
        </div>
    </div>
    
    <!-- ã‚«ã‚¹ã‚¿ãƒ ãƒ¢ãƒ¼ãƒ€ãƒ« (ãƒªã‚»ãƒƒãƒˆç¢ºèªç”¨) -->
    <div id="confirm-modal" class="fixed inset-0 bg-gray-600 bg-opacity-75 flex items-center justify-center hidden z-50">
        <div class="bg-white p-6 rounded-lg shadow-xl w-80">
            <h3 class="text-xl font-bold mb-4">ãƒªã‚»ãƒƒãƒˆã®ç¢ºèª</h3>
            <p class="mb-6 text-gray-700">ã‚²ãƒ¼ãƒ ã®çŠ¶æ…‹ã¨ä¿å­˜ãƒ‡ãƒ¼ã‚¿ã‚’ã™ã¹ã¦ãƒªã‚»ãƒƒãƒˆã—ã€æœ€åˆã‹ã‚‰ã‚„ã‚Šç›´ã—ã¾ã™ã€‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ</p>
            <div class="flex justify-end space-x-3">
                <button onclick="closeConfirmResetModal()" class="px-4 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-100 transition">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                <button onclick="confirmReset()" class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition">ãƒªã‚»ãƒƒãƒˆã™ã‚‹</button>
            </div>
        </div>
    </div>

    <!-- ã‚«ã‚¹ã‚¿ãƒ ãƒ¢ãƒ¼ãƒ€ãƒ« (è­¦å‘Šè¡¨ç¤ºç”¨) -->
    <div id="limit-modal" class="fixed inset-0 bg-gray-600 bg-opacity-75 flex items-center justify-center hidden z-50">
        <div class="bg-white p-6 rounded-lg shadow-xl w-80">
            <h3 class="text-xl font-bold mb-4 text-red-600">ã‚«ãƒ¼ãƒ‰ã®ç¨®é¡åˆ¶é™</h3>
            <p class="mb-6 text-gray-700">ã‚²ãƒ¼ãƒ ã®ãƒ«ãƒ¼ãƒ«ä¸Šã€**åŒã˜ç¨®é¡ã®ã‚«ãƒ¼ãƒ‰ã¯æœ€å¤§2æšã¾ã§**ã—ã‹å­˜åœ¨ã—ã¾ã›ã‚“ã€‚é¸æŠã•ã‚ŒãŸç¨®é¡ã¯æ—¢ã«2æšè¨˜æ†¶ã•ã‚Œã¦ã„ã‚‹ãŸã‚ã€é¸ã¹ã¾ã›ã‚“ã€‚</p>
            <div class="flex justify-end">
                <button onclick="closeLimitModal()" class="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition">é–‰ã˜ã‚‹</button>
            </div>
        </div>
    </div>

    <script>
        // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
        const STORAGE_KEY = 'memoryGameSolverState';
        const NUM_CARDS = 12;
        // ã‚«ãƒ¼ãƒ‰ãƒ‡ãƒ¼ã‚¿: ãƒ¬ã‚¢åº¦ã¨è‰²ã‚’å®šç¾©
        const CARD_RARITY_MAP = {
            'ãƒ¤ã‚¯ãƒ¢': { rarity: 'SSR', color: '#e879f9' }, // fuchsia-400 (æ˜ã‚‹ã„ç´«)
            // ä¿®æ­£ç‚¹: ã‚¿ã‚«ãƒã®è‰²ã‚’ã‚ˆã‚Šæ˜ã‚‹ã„ç´«è‰²ã«å¤‰æ›´
            'ã‚¿ã‚«ãƒ': { rarity: 'SSR', color: '#d8b4fe' }, // violet-300 (æ˜ã‚‹ã„ç´«)
            'ãƒŸãƒãƒª': { rarity: 'SR', color: '#f59e0b' }, // amber-500 (é»„è‰²ã£ã½ã„è‰²ã«å¤‰æ›´)
            'ãƒãƒ‰ã‚«': { rarity: 'SR', color: '#fcd34d' }, // amber-300 (æ˜ã‚‹ã„é»„è‰²)
            'ãƒˆãƒ¢ã‚¨': { rarity: 'R', color: '#60a5fa' }, // blue-400
            'è¦ªè¡›éšŠ': { rarity: 'N', color: '#9ca3af' }, // gray-400
        };
        const RARITY_ORDER = { 'SSR': 3, 'SR': 2, 'R': 1, 'N': 0 }; 
        const CARD_TYPES = Object.keys(CARD_RARITY_MAP);

        let memoryMap = Array(NUM_CARDS).fill(null); // å„ä½ç½®ã®ã‚«ãƒ¼ãƒ‰ç¨®é¡ (null:ä¸æ˜, 'ãƒ¤ã‚¯ãƒ¢':æ—¢çŸ¥)
        let matchedIndices = []; // ãƒšã‚¢ãŒæƒã£ãŸã‚«ãƒ¼ãƒ‰ã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹
        let currentFlipIndices = []; // ç¾åœ¨ã‚ãã£ã¦ã„ã‚‹ã‚«ãƒ¼ãƒ‰ã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ (æœ€å¤§2ã¤)
        let isInputtingTypes = false; // 2æšã‚ãã‚Šå¾Œã«ç¨®é¡å…¥åŠ›ä¸­ãƒ•ãƒ©ã‚°

        const cardGridEl = document.getElementById('card-grid');
        const suggestionTextEl = document.getElementById('suggestion-text');
        const memoryListEl = document.getElementById('memory-list');
        const selectionPanelEl = document.getElementById('selection-panel');
        const storageStatusEl = document.getElementById('storage-status');
        const alertMessageEl = document.getElementById('alert-message');
        const confirmModalEl = document.getElementById('confirm-modal');
        const limitModalEl = document.getElementById('limit-modal');


        // --- ãƒ¢ãƒ¼ãƒ€ãƒ«åˆ¶å¾¡ ---
        function showConfirmResetModal() { confirmModalEl.classList.remove('hidden'); }
        function closeConfirmResetModal() { confirmModalEl.classList.add('hidden'); }
        function confirmReset() {
            closeConfirmResetModal();
            resetGame(true);
        }
        
        function showLimitModal() { limitModalEl.classList.remove('hidden'); }
        function closeLimitModal() { limitModalEl.classList.add('hidden'); }
        
        function showAlert(message) {
            alertMessageEl.textContent = message;
            alertMessageEl.classList.remove('hidden');
        }

        function hideAlert() {
            alertMessageEl.classList.add('hidden');
        }


        // --- ãƒ‡ãƒ¼ã‚¿æ°¸ç¶šåŒ– (localStorage) ---

        /**
         * ã‚²ãƒ¼ãƒ ã®çŠ¶æ…‹ã‚’ localStorage ã«ä¿å­˜ã™ã‚‹
         */
        function saveGame() {
            try {
                const state = {
                    memoryMap: memoryMap,
                    matchedIndices: matchedIndices,
                };
                localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
                updateStorageStatus(true);
            } catch (e) {
                console.error('Failed to save game state to localStorage:', e);
                updateStorageStatus(false, 'ä¿å­˜å¤±æ•—');
            }
        }

        /**
         * localStorage ã‹ã‚‰ã‚²ãƒ¼ãƒ ã®çŠ¶æ…‹ã‚’èª­ã¿è¾¼ã‚€
         * @returns {boolean} ãƒ­ãƒ¼ãƒ‰ã«æˆåŠŸã—ãŸã‹ã©ã†ã‹
         */
        function loadGame() {
            try {
                const storedState = localStorage.getItem(STORAGE_KEY);
                if (storedState) {
                    const state = JSON.parse(storedState);
                    // èª­ã¿è¾¼ã‚“ã ãƒ‡ãƒ¼ã‚¿ã§çŠ¶æ…‹ã‚’æ›´æ–°
                    if (Array.isArray(state.memoryMap) && state.memoryMap.length === NUM_CARDS) {
                        memoryMap = state.memoryMap;
                        matchedIndices = Array.isArray(state.matchedIndices) ? state.matchedIndices : [];
                        currentFlipIndices = [];
                        isInputtingTypes = false;
                        console.log('ã‚²ãƒ¼ãƒ ã®çŠ¶æ…‹ã‚’localStorageã‹ã‚‰å¾©å…ƒã—ã¾ã—ãŸã€‚');
                        updateStorageStatus(true, 'å¾©å…ƒ');
                        return true;
                    }
                }
            } catch (e) {
                console.error('Failed to load game state from localStorage:', e);
            }
            updateStorageStatus(false, 'æ–°è¦é–‹å§‹');
            return false;
        }

        /**
         * ä¿å­˜çŠ¶æ³ã®è¡¨ç¤ºã‚’æ›´æ–°ã™ã‚‹
         * @param {boolean} success - æˆåŠŸã—ãŸã‹ã©ã†ã‹
         * @param {string} mode - 'å¾©å…ƒ' | 'æ–°è¦é–‹å§‹' | 'ä¿å­˜å¤±æ•—' | 'ãƒªã‚»ãƒƒãƒˆ'
         */
        function updateStorageStatus(success, mode) {
            let message = '';
            if (mode === 'å¾©å…ƒ') {
                message = 'âœ… ä»¥å‰ã®çŠ¶æ…‹ã‹ã‚‰å¾©å…ƒã—ã¾ã—ãŸã€‚';
            } else if (mode === 'æ–°è¦é–‹å§‹') {
                message = 'åˆå›ã‚¢ã‚¯ã‚»ã‚¹ã§ã™ã€‚ãƒ‡ãƒ¼ã‚¿ã¯è‡ªå‹•ä¿å­˜ã•ã‚Œã¾ã™ã€‚';
            } else if (mode === 'ãƒªã‚»ãƒƒãƒˆ') {
                message = 'ğŸ”„ ä¿å­˜ãƒ‡ãƒ¼ã‚¿ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã—ãŸã€‚æ–°è¦ã‚²ãƒ¼ãƒ ã‚’é–‹å§‹ã—ã¾ã™ã€‚';
            } else if (mode === 'ä¿å­˜å¤±æ•—') {
                message = 'âŒ ãƒ‡ãƒ¼ã‚¿ã®è‡ªå‹•ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸã€‚';
            } else if (success) {
                 message = 'ğŸ’¾ çŠ¶æ…‹ã‚’è‡ªå‹•ä¿å­˜ã—ã¾ã—ãŸã€‚';
            }
            storageStatusEl.textContent = message;
        }

        // --- åˆæœŸåŒ–ã¨ãƒªã‚»ãƒƒãƒˆ ---

        /**
         * ã‚²ãƒ¼ãƒ ã®çŠ¶æ…‹ã‚’åˆæœŸåŒ–ã—ã€ã‚°ãƒªãƒƒãƒ‰ã‚’æç”»ã™ã‚‹
         * @param {boolean} [forceReset=false] - trueã®å ´åˆã€localStorageã®ãƒ‡ãƒ¼ã‚¿ã‚‚å‰Šé™¤ã—ã¦å¼·åˆ¶ãƒªã‚»ãƒƒãƒˆ
         */
        function resetGame(forceReset = false) {
            if (forceReset) {
                localStorage.removeItem(STORAGE_KEY);
                updateStorageStatus(true, 'ãƒªã‚»ãƒƒãƒˆ');
            }

            if (!loadGame() || forceReset) {
                // å¾©å…ƒã•ã‚Œãªã‹ã£ãŸå ´åˆã€ã¾ãŸã¯å¼·åˆ¶ãƒªã‚»ãƒƒãƒˆã®å ´åˆã€æ–°è¦ã«åˆæœŸåŒ–
                memoryMap = Array(NUM_CARDS).fill(null);
                matchedIndices = [];
            }
            
            // UIã‚’æ›´æ–°
            currentFlipIndices = [];
            isInputtingTypes = false;
            hideAlert();
            renderGrid();
            renderSelectionPanel(); 
            updateSuggestion();
            updateMemoryList();
            
            if (!forceReset) {
                saveGame();
            }
            console.log('ã‚²ãƒ¼ãƒ ã®çŠ¶æ…‹ã‚’åˆæœŸåŒ–/å¾©å…ƒã—ã¾ã—ãŸã€‚');
        }

        // --- UIãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚° ---

        /**
         * ã‚«ãƒ¼ãƒ‰ã‚°ãƒªãƒƒãƒ‰ã‚’æç”»ã¾ãŸã¯æ›´æ–°ã™ã‚‹
         */
        function renderGrid() {
            cardGridEl.innerHTML = '';
            const isAnyFlipOrInput = currentFlipIndices.length > 0 || isInputtingTypes;

            for (let i = 0; i < NUM_CARDS; i++) {
                const cardEl = document.createElement('div');
                cardEl.className = 'card-slot rounded-lg font-bold text-center flex-col';
                cardEl.setAttribute('data-index', i);
                cardEl.style.backgroundColor = ''; // ã‚¤ãƒ³ãƒ©ã‚¤ãƒ³ã‚¹ã‚¿ã‚¤ãƒ«ã‚’ãƒªã‚»ãƒƒãƒˆ

                const cardType = memoryMap[i];
                const isMatched = matchedIndices.includes(i);
                const isFlipping = currentFlipIndices.includes(i);
                
                let contentHTML = '';
                let bgColorClass = 'card-unknown hover:bg-red-500';
                let borderColorClass = '';

                if (isMatched) {
                    // ãƒšã‚¢æˆç«‹æ¸ˆã¿
                    bgColorClass = 'card-matched'; 

                    // ç·¨é›†ãƒœã‚¿ãƒ³ã®ã‚¯ãƒ©ã‚¹ã¨ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚’å®šç¾©ï¼ˆã‚ãã‚Šä¸­ã‚„å…¥åŠ›ä¸­ã¯ç·¨é›†ä¸å¯ã«ã™ã‚‹ï¼‰
                    const editButtonClass = isAnyFlipOrInput ? 'edit-button-disabled' : 'hover:bg-indigo-600';
                    const editButtonAction = isAnyFlipOrInput ?
                        `event.stopPropagation(); console.log('ç¾åœ¨ã€ã‚ãã‚Šä¸­/ç¨®é¡å…¥åŠ›ä¸­ã®ãŸã‚ç·¨é›†ã§ãã¾ã›ã‚“ã€‚');` :
                        `event.stopPropagation(); handleEditCardType(${i})`;

                    contentHTML = `<div class="card-content">
                                        <span class="text-sm font-light text-gray-500">MATCHED</span>
                                        <span class="text-lg">${cardType}</span>
                                   </div>
                                   <button onclick="${editButtonAction}"
                                           class="edit-button text-xs bg-indigo-500 text-white rounded transition duration-150 shadow-md ${editButtonClass}">ç·¨é›†</button>`;
                    // ãƒãƒƒãƒæ¸ˆã¿ã¯é€šå¸¸ã‚¯ãƒªãƒƒã‚¯ã§ã‚ãã‚Œãªã„ã‚ˆã†ã«ã™ã‚‹ï¼ˆç·¨é›†ã¯ãƒœã‚¿ãƒ³ã‹ã‚‰è¡Œã†ï¼‰
                    cardEl.onclick = null;
                } else if (cardType !== null) {
                    // ç¨®é¡æ—¢çŸ¥ (éå»ã«ã‚ãã‚‰ã‚ŒãŸæƒ…å ±)
                    const cardData = CARD_RARITY_MAP[cardType];
                    cardEl.style.backgroundColor = cardData.color; // ã‚¤ãƒ³ãƒ©ã‚¤ãƒ³ã§ã‚«ã‚¹ã‚¿ãƒ è‰²ã‚’é©ç”¨
                    bgColorClass = 'card-known';
                    
                    // ç·¨é›†ãƒœã‚¿ãƒ³ã®ã‚¯ãƒ©ã‚¹ã¨ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚’å®šç¾©
                    const editButtonClass = isAnyFlipOrInput ? 'edit-button-disabled' : 'hover:bg-indigo-600';
                    const editButtonAction = isAnyFlipOrInput ? 
                        `event.stopPropagation(); console.log('ç¾åœ¨ã€ã‚ãã‚Šä¸­/ç¨®é¡å…¥åŠ›ä¸­ã®ãŸã‚ç·¨é›†ã§ãã¾ã›ã‚“ã€‚');` : 
                        `event.stopPropagation(); handleEditCardType(${i})`;

                    // card-contentå†…ã«ç¨®é¡åã‚’å«ã‚ã€ãã®ä¸‹ã«ç·¨é›†ãƒœã‚¿ãƒ³ã‚’é…ç½®ï¼ˆCSSã§ä½ç½®èª¿æ•´ï¼‰
                    contentHTML = `<div class="card-content">
                                        <span class="text-lg">${cardType}</span>
                                   </div>
                                   <button onclick="${editButtonAction}" 
                                           class="edit-button text-xs bg-indigo-500 text-white rounded transition duration-150 shadow-md ${editButtonClass}">ç·¨é›†</button>`;
                    cardEl.onclick = () => handleCardClick(i); 
                } else {
                    // ç¨®é¡ä¸æ˜ (è£é¢)
                    contentHTML = `<div class="card-content text-white">
                                        <span class="text-2xl">?</span>
                                        <span class="text-sm">ä½ç½® ${i + 1}</span>
                                   </div>`;
                    cardEl.onclick = () => handleCardClick(i); 
                }

                if (isFlipping) {
                    borderColorClass = 'card-flipping';
                    cardEl.classList.remove('card-unknown'); 
                    if (isInputtingTypes && memoryMap[i] === null) {
                        borderColorClass = 'border-4 border-red-500 ring-4 ring-red-300 animate-pulse';
                    }
                }
                
                cardEl.className = `card-slot rounded-lg font-bold text-center flex-col ${bgColorClass} ${borderColorClass}`;
                cardEl.innerHTML = contentHTML;

                // ä½ç½®è¡¨ç¤º (å¸¸ã«å·¦ä¸Šã«é…ç½®)
                const positionText = (i < 6 ? `ä¸Šæ®µ-${i % 6 + 1}` : `ä¸‹æ®µ-${i % 6 + 1}`);
                const positionEl = document.createElement('div');
                positionEl.className = 'position-text';
                positionEl.textContent = positionText;
                
                // è£é¢ã‚«ãƒ¼ãƒ‰ã®å ´åˆã¯ä½ç½®è¡¨ç¤ºã‚‚ç™½è‰²ã«ã™ã‚‹
                if (cardType === null && !isMatched) {
                    positionEl.classList.add('text-white');
                } else {
                    positionEl.classList.add('text-gray-800');
                }

                // ã‚¹ãƒãƒ›è¡¨ç¤ºï¼ˆå°ã•ã„ç”»é¢ï¼‰ã‹ã¤ç¨®é¡é¸æŠãƒ¢ãƒ¼ãƒ‰ã®ã¨ãã¯ä½ç½®è¡¨ç¤ºãŒé‚ªé­”ã«ãªã‚‹ãŸã‚éè¡¨ç¤ºã«ã™ã‚‹
                try {
                    if (isInputtingTypes && window.innerWidth <= 640) {
                        positionEl.style.display = 'none';
                    }
                } catch (e) {
                    // ã‚‚ã— window ãŒå­˜åœ¨ã—ãªã„ç’°å¢ƒã§ã‚‚å®‰å…¨ã«å‹•ä½œã™ã‚‹ã‚ˆã†ã«ç„¡è¦–
                }

                cardEl.prepend(positionEl);

                cardGridEl.appendChild(cardEl);
            }
            updateSuggestion();
        }

        /**
         * ç¨®é¡é¸æŠãƒ‘ãƒãƒ«ã®HTMLã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’ç”Ÿæˆã—ã€æç”»ã™ã‚‹
         */
        function renderSelectionPanel() {
            if (!isInputtingTypes) {
                selectionPanelEl.classList.add('hidden');
                selectionPanelEl.innerHTML = '';
                return;
            }
            hideAlert();

            const [idx1, idx2] = currentFlipIndices;
            let targetIndex = -1; 
            
            if (memoryMap[idx1] === null) {
                targetIndex = idx1;
            } else if (idx2 !== undefined && memoryMap[idx2] === null) {
                targetIndex = idx2;
            } else {
                isInputtingTypes = false;
                processPairCheck(); 
                return;
            }

            // ç¾åœ¨ã¾ã§ã«è¨˜æ†¶ã•ã‚Œã¦ã„ã‚‹å„ã‚«ãƒ¼ãƒ‰ã®æšæ•°ã‚’ã‚«ã‚¦ãƒ³ãƒˆ
            const typeCounts = memoryMap.reduce((acc, type) => {
                if (type !== null) {
                    acc[type] = (acc[type] || 0) + 1;
                }
                return acc;
            }, {});

            const positionText = (targetIndex < 6 ? `ä¸Šæ®µ-${targetIndex % 6 + 1}` : `ä¸‹æ®µ-${targetIndex % 6 + 1}`);
            const indexNumber = currentFlipIndices.length === 1 ? 1 : (targetIndex === idx1 ? 1 : 2); 
            const isEditing = currentFlipIndices.length === 1 && memoryMap[idx1] === null;

            let headerText = isEditing 
                ? `<span class="text-xl text-indigo-600 font-extrabold">ç¨®é¡ã‚’ä¿®æ­£</span> (ä½ç½® ${positionText}) ã®ã‚«ãƒ¼ãƒ‰ç¨®é¡ã‚’é¸æŠã—ã¦ãã ã•ã„`
                : `<span class="text-xl text-red-600 font-extrabold">${indexNumber}æšç›®</span> (ä½ç½® ${positionText}) ã®ã‚«ãƒ¼ãƒ‰ç¨®é¡ã‚’é¸æŠã—ã¦ãã ã•ã„`;

            const fullyMatchedTypes = new Set();
            memoryMap.forEach((type, index) => {
                // ãƒšã‚¢ãŒæƒã£ã¦matchedIndicesã«å«ã¾ã‚Œã‚‹ã‚«ãƒ¼ãƒ‰ã¯ã€ã‚‚ã†ãã®ç¨®é¡ã¨ã—ã¦ã‚«ã‚¦ãƒ³ãƒˆã—ãªã„
                if (type !== null && matchedIndices.includes(index)) {
                    if (matchedIndices.filter(i => memoryMap[i] === type).length === 2) {
                        fullyMatchedTypes.add(type);
                    }
                }
            });
            const availableTypes = CARD_TYPES.filter(type => !fullyMatchedTypes.has(type));

            // è‡ªå‹•å‰²å½“: é¸æŠã§ãã‚‹ç¨®é¡ãŒ1ã¤ã—ã‹æ®‹ã£ã¦ã„ãªã„å ´åˆã¯ã€æ‰‹å‹•å…¥åŠ›ã‚’çœç•¥ã—ã¦è‡ªå‹•ã§å‰²ã‚Šå½“ã¦ã‚‹
            if (availableTypes.length === 1) {
                const autoType = availableTypes[0];
                // targetIndex ã¯ä¸Šã§æ±ºå®šæ¸ˆã¿
                memoryMap[targetIndex] = autoType;
                saveGame();

                // 1æšã ã‘å†å…¥åŠ›ãƒ¢ãƒ¼ãƒ‰ã®å ´åˆã¯å‰²å½“å¾Œã«é€šå¸¸ãƒ•ãƒ­ãƒ¼ã¸æˆ»ã™
                if (idx2 === undefined) {
                    currentFlipIndices = [];
                    isInputtingTypes = false;
                    renderGrid();
                    updateMemoryList();
                    updateSuggestion();
                    return;
                }

                // 2æšãƒ•ãƒªãƒƒãƒ—çŠ¶æ…‹ã‹ã‚‰å‰²å½“ãŒç™ºç”Ÿã—ãŸå ´åˆã€ä¸¡æ–¹ç¢ºå®šã—ã¦ã„ã‚Œã°ãƒšã‚¢ãƒã‚§ãƒƒã‚¯ã¸
                if (memoryMap[idx1] !== null && memoryMap[idx2] !== null) {
                    isInputtingTypes = false;
                    renderGrid();
                    processPairCheck();
                    return;
                }

                // ã¾ã ç‰‡æ–¹ãŒæœªç¢ºå®šãªã‚‰ãƒ‘ãƒãƒ«ã‚’å†æç”»ã—ã¦æ¬¡ã®å…¥åŠ›ã¸
                renderGrid();
                renderSelectionPanel();
                return;
            }


            let html = `<p class="text-lg font-bold mb-3 text-gray-800">${headerText}</p>`;
            html += '<div class="flex flex-wrap gap-3 justify-center">'; 
            
            const sortedTypes = availableTypes.sort((a, b) => {
                return RARITY_ORDER[CARD_RARITY_MAP[b].rarity] - RARITY_ORDER[CARD_RARITY_MAP[a].rarity];
            });

            sortedTypes.forEach(type => {
                const cardData = CARD_RARITY_MAP[type];
                // ãƒœã‚¿ãƒ³ã®ãƒ†ã‚­ã‚¹ãƒˆè‰²ã‚’æ±ºå®š: åŸºæœ¬ã¯é»’æ–‡å­—ï¼ˆ#1f2937ï¼‰ã‚’ä½¿ç”¨
                const textColor = 'text-gray-900'; 
                
                // 3æšåˆ¶é™ã®ãƒã‚§ãƒƒã‚¯: æ—¢ã«2æšè¨˜æ†¶æ¸ˆã¿ã®å ´åˆã€é¸æŠä¸å¯
                const currentCount = typeCounts[type] || 0;
                const isDisabled = currentCount >= 2;
                
                const buttonClass = isDisabled ? 'opacity-50 cursor-not-allowed border-2 border-red-500' : 'hover:opacity-90 transform hover:scale-[1.02] active:scale-[0.98]';
                const action = isDisabled ? `handleLimitReached('${type}')` : `confirmCardType('${type}')`;
                
                html += `<button onclick="${action}" 
                                style="background-color: ${cardData.color};"
                                class="rounded-lg ${textColor} font-semibold shadow-lg py-3 px-6 transition duration-150 ${buttonClass}">
                            ${type} (${cardData.rarity})${isDisabled ? ' (æº€äº†)' : ''}
                        </button>`;
            });
            html += `</div>`;
            
            let cancelText = isEditing ? 'æœªé¸æŠçŠ¶æ…‹ã«ã™ã‚‹' : 'ã‚ãã‚Šã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã—ã¦è£é¢ã«æˆ»ã™ (æƒ…å ±ãƒªã‚»ãƒƒãƒˆ)';
            html += `<button onclick="cancelInput()" class="mt-4 text-sm text-gray-600 hover:text-red-600 font-medium">${cancelText}</button>`;
            
            selectionPanelEl.innerHTML = html;
            selectionPanelEl.classList.remove('hidden');
        }

        /**
         * è¨˜æ†¶æ¸ˆã¿ã®ã‚«ãƒ¼ãƒ‰ä¸€è¦§ã‚’æ›´æ–°ã™ã‚‹
         */
        function updateMemoryList() {
            const knownCards = {}; 
            let totalKnown = 0;

            memoryMap.forEach((type, index) => {
                if (type !== null && !matchedIndices.includes(index)) {
                    if (!knownCards[type]) {
                        knownCards[type] = [];
                    }
                    knownCards[type].push(index);
                    totalKnown++;
                }
            });

            if (totalKnown === 0) {
                memoryListEl.innerHTML = '<p class="text-sm text-gray-500">ã¾ã ã‚ãã‚‰ã‚ŒãŸã‚«ãƒ¼ãƒ‰ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</p>';
                return;
            }

            memoryListEl.innerHTML = '';
            const sortedTypes = Object.keys(knownCards).sort((a, b) => {
                return RARITY_ORDER[CARD_RARITY_MAP[b].rarity] - RARITY_ORDER[CARD_RARITY_MAP[a].rarity];
            });

            sortedTypes.forEach(type => {
                const indices = knownCards[type];
                const cardData = CARD_RARITY_MAP[type];

                const positionList = indices.map(i => {
                    return i < 6 ? `ä¸Šæ®µ-${i % 6 + 1}` : `ä¸‹æ®µ-${i % 6 + 1}`;
                }).join('ã€');

                const listItem = document.createElement('div');
                
                listItem.className = `p-2 rounded-lg flex justify-between items-center bg-gray-100 border-l-4 border-l-indigo-600`;
                listItem.innerHTML = `
                    <span class="font-semibold text-gray-800">${type} (${cardData.rarity})</span>
                    <span class="text-sm text-gray-600">${indices.length}æš: ${positionList}</span>
                `;
                memoryListEl.appendChild(listItem);

                if (indices.length === 1) {
                    const hintItem = document.createElement('div');
                    hintItem.className = 'text-xs text-red-600 ml-4';
                    hintItem.textContent = 'â†’ ã‚ã¨1æšã§ãƒšã‚¢ã§ã™ï¼';
                    memoryListEl.appendChild(hintItem);
                }
            });
        }

        // --- ãƒ­ã‚¸ãƒƒã‚¯ã¨ã‚¹ãƒˆãƒ©ãƒ†ã‚¸ãƒ¼ ---

        /**
         * ç¨®é¡ã®é¸æŠã§3æšåˆ¶é™ã«é”ã—ãŸå ´åˆã®å‡¦ç†
         * @param {string} type - é¸æŠã—ã‚ˆã†ã¨ã—ãŸç¨®é¡
         */
        function handleLimitReached(type) {
            console.log(`${type} ã¯æ—¢ã«2æšè¨˜æ†¶æ¸ˆã¿ã®ãŸã‚ã€é¸æŠã§ãã¾ã›ã‚“ã€‚`);
            showLimitModal(); // è­¦å‘Šãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤º
        }

        /**
         * æ—¢çŸ¥ã®ã‚«ãƒ¼ãƒ‰ã®ç¨®é¡ã‚’å†å…¥åŠ›ã™ã‚‹ãŸã‚ã®ãƒ¢ãƒ¼ãƒ‰ã‚’é–‹å§‹ã™ã‚‹
         * @param {number} index - ç·¨é›†ã™ã‚‹ã‚«ãƒ¼ãƒ‰ã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹
         */
        function handleEditCardType(index) {
            // ç·¨é›†ã¯ã€ã‚ãã‚Šä¸­/ç¨®é¡å…¥åŠ›ä¸­ä»¥å¤–ãªã‚‰å¯èƒ½ã«ã™ã‚‹ã€‚
            if (currentFlipIndices.length > 0 || isInputtingTypes) {
                return;
            }

            console.log(`ä½ç½® ${index + 1} ã®ã‚«ãƒ¼ãƒ‰ç¨®é¡ã‚’å†å…¥åŠ›ã—ã¾ã™ã€‚`);

            // ã‚‚ã—ãƒãƒƒãƒæ¸ˆã¿ã®ã‚«ãƒ¼ãƒ‰ã‚’ç·¨é›†ã™ã‚‹å ´åˆã¯ã€è©²å½“ãƒšã‚¢ã‚’æœªãƒãƒƒãƒçŠ¶æ…‹ã«æˆ»ã™
            if (matchedIndices.includes(index)) {
                const matchedType = memoryMap[index];
                // ãƒšã‚¢ã‚’ matchedIndices é…åˆ—ã‹ã‚‰é™¤å¤–ã™ã‚‹ï¼ˆåŒã˜ç¨®é¡ã§ãƒãƒƒãƒã—ã¦ã„ã‚‹ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’æ¢ã™ï¼‰
                const pairIndices = matchedIndices.filter(i => memoryMap[i] === matchedType);
                matchedIndices = matchedIndices.filter(i => !pairIndices.includes(i));
            }

            // ç·¨é›†å¯¾è±¡ã®ç¨®é¡æƒ…å ±ã‚’ä¸€æ—¦ãƒªã‚»ãƒƒãƒˆã—ã¦ã€ç¨®é¡å…¥åŠ›ãƒ¢ãƒ¼ãƒ‰ã¸ç§»è¡Œ
            currentFlipIndices = [index];
            memoryMap[index] = null;
            isInputtingTypes = true;
            renderGrid();
            renderSelectionPanel();
            saveGame();
        }

        /**
         * ã‚«ãƒ¼ãƒ‰ã‚¯ãƒªãƒƒã‚¯æ™‚ã®çµ±åˆãƒãƒ³ãƒ‰ãƒ©ï¼ˆã‚ãã‚Šæ“ä½œï¼‰
         * @param {number} index - ã‚¯ãƒªãƒƒã‚¯ã•ã‚ŒãŸã‚«ãƒ¼ãƒ‰ã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹
         */
        function handleCardClick(index) {
            // æ—¢ã«ãƒãƒƒãƒæ¸ˆã¿ã®ã‚«ãƒ¼ãƒ‰ã¯æ“ä½œä¸å¯
            if (matchedIndices.includes(index)) {
                return;
            }

            // ç¨®é¡å…¥åŠ›ä¸­ã¯ã€ã‚ãã‚Šä¸­ã®ã‚«ãƒ¼ãƒ‰ä»¥å¤–ã¯è§¦ã‚Œãªã„
            if (isInputtingTypes && !currentFlipIndices.includes(index)) {
                return;
            }

            // 1æšç›®é¸æŠæ™‚ã€åŒã˜ã‚«ãƒ¼ãƒ‰ã‚’å†åº¦ã‚¯ãƒªãƒƒã‚¯ã—ãŸã‚‰é¸æŠã‚’è§£é™¤ã™ã‚‹
            if (currentFlipIndices.length === 1 && currentFlipIndices[0] === index) {
                cancelInput(); // æœªé¸æŠçŠ¶æ…‹ã«æˆ»ã™
                console.log(`ã‚«ãƒ¼ãƒ‰ (ä½ç½® ${index + 1}) ã®é¸æŠã‚’è§£é™¤ã—ã¾ã—ãŸã€‚`);
                return;
            }
            
            // æ—¢ã«2æšã‚ãã£ã¦ã„ã‚‹çŠ¶æ…‹ã§ã¯æ“ä½œä¸å¯
            if (currentFlipIndices.length === 2) {
                return;
            }

            // 0æšç›® -> 1æšç›® ã¾ãŸã¯ 1æšç›® -> 2æšç›® (ç•°ãªã‚‹ã‚«ãƒ¼ãƒ‰)
            if (!currentFlipIndices.includes(index)) {
                 currentFlipIndices.push(index);
                 console.log(`ã‚«ãƒ¼ãƒ‰ (ä½ç½® ${index + 1}) ã‚’ã‚ãã‚Šã¾ã—ãŸã€‚ç¾åœ¨ã®æšæ•°: ${currentFlipIndices.length}`);
            } else {
                return; // æ—¢ã«ã‚ãã‚Šä¸­ã®ã‚«ãƒ¼ãƒ‰ã‚’å†åº¦ã‚¯ãƒªãƒƒã‚¯ã—ãŸå ´åˆ
            }

            // UIã®æ›´æ–°ãƒ­ã‚¸ãƒƒã‚¯ã‚’ç¶™ç¶š
            if (currentFlipIndices.length === 1) {
                renderGrid();
                updateSuggestion();
            } else if (currentFlipIndices.length === 2) {
                const [idx1, idx2] = currentFlipIndices;
                const needsInput = memoryMap[idx1] === null || memoryMap[idx2] === null;

                if (needsInput) {
                    // å°‘ãªãã¨ã‚‚1æšãŒä¸æ˜ãªå ´åˆ: ç¨®é¡å…¥åŠ›ãƒ¢ãƒ¼ãƒ‰ã¸ç§»è¡Œ
                    isInputtingTypes = true; 
                    renderGrid();
                    renderSelectionPanel();
                    console.log(`2æšã®ã‚«ãƒ¼ãƒ‰ã‚’ã‚ãã‚Šã¾ã—ãŸã€‚ç¨®é¡å…¥åŠ›ãƒ¢ãƒ¼ãƒ‰ã¸ç§»è¡Œã—ã¾ã™ã€‚`);
                } else {
                    // ä¸¡æ–¹æ—¢çŸ¥ã®å ´åˆ: å³æ™‚ãƒšã‚¢ãƒã‚§ãƒƒã‚¯
                    isInputtingTypes = false;
                    renderGrid();
                    processPairCheck();
                    console.log(`æ—¢çŸ¥ã®ã‚«ãƒ¼ãƒ‰ (${memoryMap[idx1]}, ${memoryMap[idx2]}) ã‚’ã‚ãã‚Šã¾ã—ãŸã€‚å³æ™‚ãƒšã‚¢ãƒã‚§ãƒƒã‚¯ã‚’å®Ÿè¡Œã—ã¾ã™ã€‚`);
                }
            }
        }

        /**
         * ç¾åœ¨å…¥åŠ›ä¸­ã®ã‚«ãƒ¼ãƒ‰ã®ç¨®é¡ã‚’ç¢ºå®šã—ã€æ¬¡ã®å…¥åŠ›ã¸é€²ã‚€ã‹ãƒšã‚¢ãƒã‚§ãƒƒã‚¯ã‚’è¡Œã†
         * @param {string} type - ç¢ºå®šã—ãŸã‚«ãƒ¼ãƒ‰ã®ç¨®é¡
         */
        function confirmCardType(type) {
            if (!isInputtingTypes || currentFlipIndices.length < 1) return;

            hideAlert(); // è­¦å‘Šã‚’éè¡¨ç¤ºã«ã™ã‚‹
            
            const [idx1, idx2] = currentFlipIndices;
            let targetIndex = -1; 
            if (memoryMap[idx1] === null) {
                targetIndex = idx1;
            } else if (idx2 !== undefined && memoryMap[idx2] === null) {
                targetIndex = idx2;
            } else {
                return;
            }

            // ç¨®é¡ã‚’è¨˜æ†¶
            memoryMap[targetIndex] = type;
            saveGame();

            if (idx2 === undefined) {
                // 1æšã®å†å…¥åŠ›å®Œäº†
                currentFlipIndices = [];
                isInputtingTypes = false;
                renderGrid();
                renderSelectionPanel();
                updateMemoryList();
                updateSuggestion();
                return;
            }

            // 2æšãƒ•ãƒªãƒƒãƒ—çŠ¶æ…‹ã‹ã‚‰ã®å®Œäº†ãƒã‚§ãƒƒã‚¯
            if (memoryMap[idx1] !== null && memoryMap[idx2] !== null) {
                // 2æšã¨ã‚‚ç¨®é¡ãŒç¢ºå®šã—ãŸ -> ãƒšã‚¢ãƒã‚§ãƒƒã‚¯ã¸
                isInputtingTypes = false;
                renderSelectionPanel();
                processPairCheck();
            } else {
                // 1æšç›®ã®ç¨®é¡ãŒç¢ºå®šã—ãŸ -> 2æšç›®ã®ç¨®é¡å…¥åŠ›ãƒ‘ãƒãƒ«ã‚’å†æç”»
                renderGrid();
                renderSelectionPanel();
            }
        }
        
        /**
         * ãƒšã‚¢ãƒã‚§ãƒƒã‚¯ã‚’è¡Œã„ã€çŠ¶æ…‹ã‚’æ›´æ–°ã™ã‚‹
         */
        function processPairCheck() {
            const [idx1, idx2] = currentFlipIndices;
            const type1 = memoryMap[idx1];
            const type2 = memoryMap[idx2];
            
            if (type1 === type2) {
                setTimeout(() => {
                    matchedIndices.push(idx1, idx2);
                    currentFlipIndices = [];
                    renderGrid();
                    updateMemoryList();
                    updateSuggestion();
                    saveGame();
                }, 500);
            } else {
                setTimeout(() => {
                    currentFlipIndices = [];
                    renderGrid();
                    updateSuggestion();
                }, 1000);
            }
        }

        /**
         * ã‚ãã‚Šã¨ç¨®é¡å…¥åŠ›ã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã—ã€æœªé¸æŠ/è£é¢ã«æˆ»ã™ (cancelInput)
         */
        function cancelInput() {
            
            isInputtingTypes = false;
            currentFlipIndices = [];
            hideAlert();
            renderGrid();
            renderSelectionPanel();
            updateMemoryList();
            updateSuggestion();
            saveGame();
        }

        /**
         * æ¬¡ã«ã‚ãã‚‹ã¹ãã‚«ãƒ¼ãƒ‰ã‚’ææ¡ˆã—ã€UIã‚’æ›´æ–°ã™ã‚‹
         */
        function updateSuggestion() {
            if (isInputtingTypes) {
                suggestionTextEl.innerHTML = "ğŸš¨ ç¨®é¡å…¥åŠ›ä¸­ï¼šç”»é¢ä¸‹éƒ¨ã®ãƒ‘ãƒãƒ«ã‹ã‚‰ã€ã‚ãã£ãŸã‚«ãƒ¼ãƒ‰ã®ç¨®é¡ã‚’é †ç•ªã«ã€ã¾ãŸã¯ä¿®æ­£ã—ã¦ç¢ºå®šã—ã¦ãã ã•ã„ï¼";
                return;
            }

            let suggestedIndex = -1;
            let suggestionMessage = "ğŸ¤” ã€æ¢ç´¢é–‹å§‹ã€‘ ã¾ãšã¯ä¸æ˜ãªã‚«ãƒ¼ãƒ‰ã‚’1æšã‚ãã‚Šã€è¨˜æ†¶æƒ…å ±ã‚’å¢—ã‚„ã—ã¾ã—ã‚‡ã†ã€‚";

            // --- çŠ¶æ…‹ã®åˆ†æ ---
            const knownSinglesMap = {}; // { type: [index] } 1æšã ã‘è¨˜æ†¶ã•ã‚Œã¦ã„ã‚‹ç¨®é¡
            const knownCards = {}; // { type: [index, index, ...] } ãƒãƒƒãƒã—ã¦ã„ãªã„å…¨ã¦ã®æ—¢çŸ¥ã‚«ãƒ¼ãƒ‰
            const unknownIndices = memoryMap.map((type, i) => 
                (type === null && !matchedIndices.includes(i) ? i : -1)
            ).filter(i => i !== -1);
            
            memoryMap.forEach((type, index) => {
                if (type !== null && !matchedIndices.includes(index)) {
                    knownCards[type] = (knownCards[type] || []).concat(index);
                }
            });

            // knownSinglesMapã®æ§‹ç¯‰ (1æšã—ã‹è¨˜æ†¶ã•ã‚Œã¦ã„ãªã„ç¨®é¡ã®ã¿)
            const totalKnownCounts = memoryMap.reduce((acc, type) => {
                if (type !== null) {
                    acc[type] = (acc[type] || 0) + 1;
                }
                return acc;
            }, {});

            Object.keys(knownCards).forEach(type => {
                 // ãƒãƒƒãƒæ¸ˆã¿ã‚’é™¤ã„ãŸã€ç¾åœ¨è¨˜æ†¶ã•ã‚Œã¦ã„ã‚‹æšæ•°
                const count = knownCards[type].length; 
                if (count === 1 && totalKnownCounts[type] === 1) { // æ—¢çŸ¥ã§æœªãƒãƒƒãƒãŒ1æšã€ã‹ã¤å…¨ä½“ã§ã‚‚1æš
                    knownSinglesMap[type] = knownCards[type];
                }
            });

            const knownSingleIndices = Object.values(knownSinglesMap).flat(); // æ—¢çŸ¥ã®ã‚·ãƒ³ã‚°ãƒ«ã‚«ãƒ¼ãƒ‰ã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ [i_A, i_B, ...]


            const isFirstFlip = currentFlipIndices.length === 1;
            const currentFlipIndex = isFirstFlip ? currentFlipIndices[0] : -1;
            const allKnownOrMatched = memoryMap.every((type, i) => type !== null || matchedIndices.includes(i));
            
            // --- P1: æ—¢çŸ¥ã®ãƒšã‚¢ã‚’æƒãˆã‚‹ (100% Match) ---
            let matchablePair = null;
            let matchableType = null;

            const sortedKnownTypes = Object.keys(knownCards).sort((a, b) => {
                return RARITY_ORDER[CARD_RARITY_MAP[b].rarity] - RARITY_ORDER[CARD_RARITY_MAP[a].rarity];
            });

            for (const type of sortedKnownTypes) {
                const indices = knownCards[type];
                if (indices.length === 2) {
                    matchablePair = indices;
                    matchableType = type;
                    break; 
                }
            }

            if (matchablePair) {
                // P1ãŒé©ç”¨ã•ã‚Œã‚‹å ´åˆ
                let targetIndex = -1;
                
                if (isFirstFlip && matchablePair.includes(currentFlipIndex)) {
                    targetIndex = matchablePair.find(i => i !== currentFlipIndex);
                } else if (!isFirstFlip) {
                    targetIndex = matchablePair[0];
                }
                
                if (targetIndex !== -1 && !currentFlipIndices.includes(targetIndex)) {
                     suggestedIndex = targetIndex;
                     const position = suggestedIndex < 6 ? `ä¸Šæ®µ-${suggestedIndex % 6 + 1}` : `ä¸‹æ®µ-${suggestedIndex % 6 + 1}`;
                     suggestionMessage = `ğŸŒŸ ã€æœ€å„ªå…ˆã€‘æ—¢çŸ¥ã®ãƒšã‚¢ï¼š${matchableType} (${CARD_RARITY_MAP[matchableType].rarity}) ã®ã‚«ãƒ¼ãƒ‰ã‚’æƒãˆã¾ã—ã‚‡ã†ï¼${position} ã‚’ã‚ãã£ã¦ãã ã•ã„ã€‚`;
                     return applySuggestion(suggestedIndex, suggestionMessage);
                }
            }
            
            // --- P2: ç‰¹æ®Šå±€é¢: æ—¢çŸ¥2æš(ã‚·ãƒ³ã‚°ãƒ«) + ä¸æ˜2æš ã®é«˜åŠ¹ç‡æˆ¦ç•¥ ---
            if (unknownIndices.length === 2 && knownSingleIndices.length === 2 && matchedIndices.length <= NUM_CARDS - 4) {
                // æ—¢çŸ¥ã®ã‚·ãƒ³ã‚°ãƒ«ã‚«ãƒ¼ãƒ‰2æš (A, B) ã¨ä¸æ˜ãªã‚«ãƒ¼ãƒ‰2æš (?, ??) ãŒæ®‹ã£ã¦ã„ã‚‹ã€‚
                
                if (isFirstFlip) {
                    const flippedIndex = currentFlipIndices[0];

                    if (knownSingleIndices.includes(flippedIndex)) {
                        // 1æšç›®: æ—¢çŸ¥ã®ã‚·ãƒ³ã‚°ãƒ« (A) ã‚’ã‚ãã£ãŸå ´åˆ -> 2æšç›®ã¯ä¸æ˜2æšã®ã©ã¡ã‚‰ã§ã‚‚ç­‰ä¾¡ãªã®ã§ä¸¡æ–¹ææ¡ˆ
                        suggestedIndex = unknownIndices.slice();
                        const flippedType = memoryMap[flippedIndex];
                        const posList = unknownIndices.map(i => i < 6 ? `ä¸Šæ®µ-${i % 6 + 1}` : `ä¸‹æ®µ-${i % 6 + 1}`).join(' ã¨ ');
                        suggestionMessage = `ğŸš€ ã€æœ€çµ‚å±€é¢ã€‘ æ®‹ã‚Š4æšã§ã™ã€‚ä»Šã‚ãã£ãŸ ${flippedType} (${CARD_RARITY_MAP[flippedType].rarity}) ã®ãƒšã‚¢ã¯è£é¢ã®ã©ã¡ã‚‰ã‹ã«ã‚ã‚Šã¾ã™ã€‚${posList} ã®ã©ã¡ã‚‰ã‚’ã‚ãã£ã¦ã‚‚åŒã˜æœŸå¾…å€¤ã§ã™ã€‚50%ã®ãƒšã‚¢æˆç«‹ã‚’ç‹™ã„ã¤ã¤ã€æ®‹ã‚Š2æšã®ç¨®é¡ã‚’ç¢ºå®šã•ã›ã¾ã—ã‚‡ã†ã€‚`;
                    } else if (unknownIndices.includes(flippedIndex)) {
                        // 1æšç›®: ä¸æ˜ (?) ã‚’ã‚ãã£ãŸå ´åˆ -> 2æšç›®ã¯æ—¢çŸ¥ã®2æšã©ã¡ã‚‰ã§ã‚‚ç­‰ä¾¡ãªã®ã§ä¸¡æ–¹ææ¡ˆ
                        suggestedIndex = knownSingleIndices.slice();
                        const posList = knownSingleIndices.map(i => i < 6 ? `ä¸Šæ®µ-${i % 6 + 1}` : `ä¸‹æ®µ-${i % 6 + 1}`).join(' ã¨ ');
                        suggestionMessage = `ğŸš€ ã€æœ€çµ‚å±€é¢ã€‘ æ®‹ã‚Š4æšã§ã™ã€‚ä»Šã‚ãã£ãŸã‚«ãƒ¼ãƒ‰ã®ãƒšã‚¢ã¯æ—¢çŸ¥ã®ã©ã¡ã‚‰ã‹ã«ã‚ã‚Šã¾ã™ã€‚${posList} ã®ã©ã¡ã‚‰ã‚’ã‚ãã£ã¦ã‚‚åŒã˜æœŸå¾…å€¤ã§ã™ã€‚50%ã®ãƒšã‚¢æˆç«‹ã‚’ç‹™ã„ã¤ã¤ã€æ®‹ã‚Šã‚«ãƒ¼ãƒ‰ã®ç¨®é¡ã‚’ç¢ºå®šã•ã›ã¾ã—ã‚‡ã†ã€‚`;
                    }
                } else { 
                    // 0æšã‚ãã‚Šä¸­: æ—¢çŸ¥ã®ã‚·ãƒ³ã‚°ãƒ« 1æšã¨ ä¸æ˜ 1æšã‚’ã‚ãã‚‹ã‚ˆã†ææ¡ˆ
                    const knownPosA = knownSingleIndices[0];
                    const knownPosB = knownSingleIndices[1];
                    const unknownPosition = unknownIndices[0];

                    const positionA = knownPosA < 6 ? `ä¸Šæ®µ-${knownPosA % 6 + 1}` : `ä¸‹æ®µ-${knownPosA % 6 + 1}`;
                    const positionB = knownPosB < 6 ? `ä¸Šæ®µ-${knownPosB % 6 + 1}` : `ä¸‹æ®µ-${knownPosB % 6 + 1}`;

                    suggestedIndex = [knownPosA, knownPosB];

                    suggestionMessage = `ğŸš€ ã€æœ€çµ‚å±€é¢ã€‘ æ®‹ã‚Š4æšã§ã™ã€‚ã©ã¡ã‚‰ã®æ—¢çŸ¥ã‚·ãƒ³ã‚°ãƒ« (${positionA} ã¾ãŸã¯ ${positionB}) ã‚’ã‚ãã£ã¦ã‚‚åŒã˜æœŸå¾…å€¤ã§ã™ã€‚ãŠå¥½ã¿ã§ã©ã¡ã‚‰ã‹ã‚’é¸ã‚“ã§50%ã®ãƒšã‚¢æˆç«‹ã‚’ç‹™ã„ã¾ã—ã‚‡ã†ã€‚`;
                }
                
                if (suggestedIndex !== -1) {
                    return applySuggestion(suggestedIndex, suggestionMessage);
                }
            } 


            // --- P3: æ¢ç´¢ (Unknown or Known Single Exploration) ---
            if (isFirstFlip) {
                const flippedType = memoryMap[currentFlipIndex];

                // 1æšç›®ãŒæ—¢çŸ¥ã®ã‚·ãƒ³ã‚°ãƒ«ã‚«ãƒ¼ãƒ‰ (A) ã§ã€æ¬¡ã«ä¸æ˜ãªã‚«ãƒ¼ãƒ‰ã‚’ã‚ãã‚‹
                const isKnownSingle = flippedType !== null && knownSingleIndices.includes(currentFlipIndex);

                // æ—¢çŸ¥ã®ã‚·ãƒ³ã‚°ãƒ«ã‚«ãƒ¼ãƒ‰ã‚’1æšç›®ã«é¸æŠã—ãŸå ´åˆã®æ‰±ã„
                // â†’ ç‰¹æ®Šå±€é¢ï¼ˆæ—¢çŸ¥2æšï¼‹ä¸æ˜2æšï¼‰ã®æ™‚ã®ã¿ã€Œ50%ãƒãƒ£ãƒ³ã‚¹ã€ã¨ã—ã¦æ‰±ã†ã€‚ãã‚Œä»¥å¤–ã¯å …å®Ÿã«æ–°è¦ã‚«ãƒ¼ãƒ‰ã‚’ã‚ãã‚‹ææ¡ˆã¨ã™ã‚‹ã€‚
                if (isKnownSingle && unknownIndices.length === 2 && knownSingleIndices.length === 2 && matchedIndices.length <= NUM_CARDS - 4) {
                    suggestedIndex = unknownIndices[0];
                    const position = suggestedIndex < 6 ? `ä¸Šæ®µ-${suggestedIndex % 6 + 1}` : `ä¸‹æ®µ-${suggestedIndex % 6 + 1}`;
                    suggestionMessage = `ğŸ¯ ã€50%ãƒãƒ£ãƒ³ã‚¹ã€‘ 1æšç›®(${flippedType}, ${CARD_RARITY_MAP[flippedType].rarity})ã®ãƒšã‚¢ã¯è£é¢ã®ã©ã¡ã‚‰ã‹ã«ã‚ã‚Šã¾ã™ã€‚ç‰¹æ®Šå±€é¢ãªã®ã§ã€${position} ã‚’ã‚ãã£ã¦50%ã§æƒã†ã“ã¨ã‚’ç‹™ã„ã¾ã—ã‚‡ã†ã€‚`;
                } 
                // 1æšç›®ãŒä¸æ˜ or æ—¢çŸ¥ã®ãƒšã‚¢(2æšæƒã£ã¦ã„ã‚‹çŠ¶æ…‹)ã‚’ã‚ãã£ãŸå ´åˆ
                else if (unknownIndices.length > 0) {
                    suggestedIndex = unknownIndices[0];
                    const position = suggestedIndex < 6 ? `ä¸Šæ®µ-${suggestedIndex % 6 + 1}` : `ä¸‹æ®µ-${suggestedIndex % 6 + 1}`;
                    suggestionMessage = `ğŸ’¡ ã€è¨˜æ†¶ã‚’å¢—ã‚„ã™ã€‘ ãƒšã‚¢ã«ãªã‚‹ã‚«ãƒ¼ãƒ‰ã¯ã¾ã ä¸æ˜ã§ã™ã€‚æ¬¡ã®ä¸æ˜ãªã‚«ãƒ¼ãƒ‰ã€${position} ã‚’ã‚ãã‚Šã€è¨˜æ†¶ã‚’å¢—ã‚„ã—ã¾ã—ã‚‡ã†ã€‚`;
                } else if (allKnownOrMatched) {
                    // 1æšç›®ã‚ãã‚Šä¸­ã§ã€æ®‹ã‚Šã®ã‚«ãƒ¼ãƒ‰ãŒã™ã¹ã¦æ—¢çŸ¥ï¼ˆæœªæˆç«‹ï¼‰ã¾ãŸã¯ãƒãƒƒãƒæ¸ˆã¿
                    suggestionMessage = `ğŸ§ ã€æ®‹ã‚Šã‚’æ¢ã‚‹ã€‘ 1æšç›®ã®ã‚«ãƒ¼ãƒ‰ã®ãƒšã‚¢ã¯ã¾ã ä¸æ˜ã§ã™ã€‚è¨˜æ†¶æ¸ˆã¿ã®ã‚«ãƒ¼ãƒ‰ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ã€æ®‹ã‚Š1æšã®ãƒšã‚¢ã‚’æ¢ã‚‹ã‹ã€ã‚ãã‚Šã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã—ã¾ã—ã‚‡ã†ã€‚`;
                }

            } else if (currentFlipIndices.length === 0) {
                // --- P4: æ¢ç´¢é–‹å§‹ (Initial Exploration) ---
                if (unknownIndices.length > 0) {
                    suggestedIndex = unknownIndices[0];
                    const position = suggestedIndex < 6 ? `ä¸Šæ®µ-${suggestedIndex % 6 + 1}` : `ä¸‹æ®µ-${suggestedIndex % 6 + 1}`;
                    suggestionMessage = `ğŸ¤” ã€æ¢ç´¢é–‹å§‹ã€‘ ã¾ãšã¯ä¸æ˜ãªã‚«ãƒ¼ãƒ‰ã€${position} ã‚’ã‚ãã£ã¦æƒ…å ±ã‚’å–å¾—ã—ã¾ã—ã‚‡ã†ã€‚`;
                } else if (matchedIndices.length === NUM_CARDS) {
                    suggestionMessage = "ğŸ‰ ã™ã¹ã¦ã®ãƒšã‚¢ãŒæƒã„ã¾ã—ãŸï¼ã‚²ãƒ¼ãƒ ã‚¯ãƒªã‚¢ã§ã™ï¼";
                } else if (allKnownOrMatched) {
                    suggestionMessage = "ğŸ§ ã€è¨˜æ†¶æ¸ˆã¿ã€‘ ã™ã¹ã¦ã®è£é¢ã‚«ãƒ¼ãƒ‰ã‚’ã‚ãã‚Šçµ‚ãˆã¾ã—ãŸã€‚æ¬¡ã®ã‚¿ãƒ¼ãƒ³ã¯è¨˜æ†¶æ¸ˆã¿ã®ã‚«ãƒ¼ãƒ‰ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ãƒšã‚¢ã‚’æƒãˆã¾ã—ã‚‡ã†ã€‚";
                }
            }

            // ææ¡ˆãŒç¾åœ¨ã‚ãã£ã¦ã„ã‚‹ã‚«ãƒ¼ãƒ‰ã¨é‡è¤‡ã—ã¦ã„ãªã„ã‹ã‚’ä¿é™º
            let indicesToConsider = [];
            if (Array.isArray(suggestedIndex)) {
                indicesToConsider = suggestedIndex.slice();
            } else if (suggestedIndex !== -1) {
                indicesToConsider = [suggestedIndex];
            }

            if (indicesToConsider.length > 0 && indicesToConsider.some(i => currentFlipIndices.includes(i))) {
                // ç¾åœ¨ã‚ãã£ã¦ã„ã‚‹ã‚«ãƒ¼ãƒ‰ã¨é‡è¤‡ã™ã‚‹å€™è£œã¯é™¤å¤–ã™ã‚‹
                indicesToConsider = indicesToConsider.filter(i => !currentFlipIndices.includes(i) && !matchedIndices.includes(i));

                if (indicesToConsider.length === 0) {
                    // æœªç¢ºèªã®ã‚«ãƒ¼ãƒ‰ã‹ã‚‰ç¾åœ¨ã‚ãã£ã¦ã„ã‚‹ã‚«ãƒ¼ãƒ‰ã¨é‡è¤‡ã—ãªã„å€™è£œã‚’æ¢ã™
                    const alt = unknownIndices.find(i => !currentFlipIndices.includes(i) && !matchedIndices.includes(i));
                    if (alt !== undefined) {
                        indicesToConsider = [alt];
                        const position = alt < 6 ? `ä¸Šæ®µ-${alt % 6 + 1}` : `ä¸‹æ®µ-${alt % 6 + 1}`;
                        suggestionMessage = `ğŸ’¡ ã€è¨˜æ†¶ã‚’å¢—ã‚„ã™ã€‘ æ¬¡ã®ä¸æ˜ãªã‚«ãƒ¼ãƒ‰ã€${position} ã‚’ã‚ãã‚Šã€è¨˜æ†¶ã‚’å¢—ã‚„ã—ã¾ã—ã‚‡ã†ã€‚`;
                    } else {
                        // ä»£æ›¿ãŒè¦‹ã¤ã‹ã‚‰ãªã„å ´åˆã¯ææ¡ˆã‚’å‡ºã•ãªã„
                        indicesToConsider = [];
                        suggestionMessage = `ğŸ§ ç¾åœ¨ã®é¸æŠã¨é‡è¤‡ã™ã‚‹ãŸã‚ã€åˆ¥ã®ã‚«ãƒ¼ãƒ‰ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚`;
                    }
                }
            }

            // æ¨å¥¨ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’å˜ä¸€å€¤ã¾ãŸã¯é…åˆ—ã¨ã—ã¦ applySuggestion ã«æ¸¡ã™
            let finalSuggested = -1;
            if (indicesToConsider.length === 1) finalSuggested = indicesToConsider[0];
            else if (indicesToConsider.length > 1) finalSuggested = indicesToConsider;

            applySuggestion(finalSuggested, suggestionMessage);
        }

        /**
         * ææ¡ˆã‚’UIã«é©ç”¨ã™ã‚‹ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°
         * @param {number} suggestedIndex - ãƒã‚¤ãƒ©ã‚¤ãƒˆã™ã‚‹ã‚«ãƒ¼ãƒ‰ã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ (-1 ã®å ´åˆã¯ãƒã‚¤ãƒ©ã‚¤ãƒˆãªã—)
         * @param {string} message - è¡¨ç¤ºã™ã‚‹ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
         */
        function applySuggestion(suggestedIndex, message) {
            suggestionTextEl.innerHTML = message;

            // å…¨ã¦ã®æ—¢å­˜ãƒã‚¤ãƒ©ã‚¤ãƒˆã‚’ã‚¯ãƒªã‚¢
            document.querySelectorAll('.card-slot').forEach(el => {
                el.classList.remove('card-suggested');
                el.style.animation = 'none';
                void el.offsetWidth; // ãƒªãƒ•ãƒ­ãƒ¼ã‚’å¼·åˆ¶
            });

            if (suggestedIndex === -1 || suggestedIndex === null || suggestedIndex === undefined) return;

            const indices = Array.isArray(suggestedIndex) ? suggestedIndex : [suggestedIndex];

            indices.forEach(idx => {
                // ç¾åœ¨ã‚ãã‚Šä¸­ã®ã‚«ãƒ¼ãƒ‰ã‚„æ—¢ã«ãƒãƒƒãƒæ¸ˆã¿ã®ã‚«ãƒ¼ãƒ‰ã¯ãƒã‚¤ãƒ©ã‚¤ãƒˆã—ãªã„
                if (currentFlipIndices.includes(idx) || matchedIndices.includes(idx)) return;
                const el = document.querySelector(`.card-slot[data-index="${idx}"]`);
                if (el) {
                    el.classList.add('card-suggested');
                    el.style.animation = 'pulse-border 1.5s infinite';
                }
            });
        }


        // --- ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ ---
        window.onload = () => resetGame(false);

    </script>
</body>
</html>